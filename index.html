<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wealth Management Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js"></script>
</head>
<body class="bg-gray-50">
    <div id="app" class="max-w-7xl mx-auto p-6">
        <!-- Loading Section -->
        <div id="loading-section" class="text-center mt-20">
            <div class="bg-white rounded-lg shadow p-8 max-w-md mx-auto">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Loading...</h2>
                <p class="text-gray-600">Connecting to Google Sheets</p>
                <div class="mt-4">
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                </div>
            </div>
        </div>

        <!-- Auth Section -->
        <div id="auth-section" class="hidden">
            <div class="bg-white rounded-lg shadow p-8 text-center max-w-md mx-auto mt-20">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Welcome to Wealth Management Platform</h2>
                <p class="text-gray-600 mb-6">Please sign in with Google to access your portfolio data</p>
                <button id="authorize-button" class="px-6 py-3 bg-blue-600 text-white rounded-md hover:bg-blue-700 font-medium">
                    üîê Sign in with Google
                </button>
                <p class="text-sm text-gray-500 mt-4">Your data is stored in your personal Google Sheet</p>
                <p class="text-xs text-red-500 mt-2" id="error-msg"></p>
            </div>
        </div>

        <!-- Main App -->
        <div id="main-app" class="hidden">
            <header class="mb-8">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-800 mb-2">Wealth Management Platform</h1>
                        <p class="text-gray-600">Multi-investor portfolio & investment tracking for Indian equities</p>
                        <p class="text-sm text-green-600 mt-1">‚úì Connected to Google Sheets</p>
                    </div>
                    <div class="flex gap-2 items-center">
                        <button onclick="syncData()" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 text-sm font-medium">
                            üîÑ Sync Now
                        </button>
                        <button id="signout-button" class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 text-sm font-medium">
                            Sign Out
                        </button>
                    </div>
                </div>
            </header>

            <!-- Navigation -->
            <nav class="mb-6 flex flex-wrap gap-2 border-b pb-4">
                <button onclick="showTab('investors')" id="tab-investors" class="px-4 py-2 rounded font-medium tab-btn">Investors</button>
                <button onclick="showTab('transactions')" id="tab-transactions" class="px-4 py-2 rounded font-medium tab-btn">Transactions</button>
                <button onclick="showTab('portfolio')" id="tab-portfolio" class="px-4 py-2 rounded font-medium tab-btn">Portfolio</button>
                <button onclick="showTab('reports')" id="tab-reports" class="px-4 py-2 rounded font-medium tab-btn">Reports</button>
            </nav>

            <!-- Investors Tab -->
            <div id="investors-tab" class="tab-content">
                <div class="bg-white rounded-lg shadow p-6 mb-6">
                    <h2 class="text-xl font-semibold mb-4">Add New Investor</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Investor Name</label>
                            <input type="text" id="investor-name" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Enter name">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">PAN Card Number</label>
                            <input type="text" id="investor-pan" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="ABCDE1234F" maxlength="10">
                        </div>
                    </div>
                    <button onclick="addInvestor()" class="mt-4 px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Add Investor</button>
                </div>

                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-xl font-semibold mb-4">Registered Investors</h2>
                    <div id="investors-list" class="space-y-2"></div>
                </div>
            </div>

            <!-- Transactions Tab -->
            <div id="transactions-tab" class="tab-content hidden">
                <div class="bg-white rounded-lg shadow p-6 mb-6">
                    <h2 class="text-xl font-semibold mb-4">Add Transaction</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Select Investor</label>
                            <select id="txn-investor" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">Select investor...</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Transaction Type</label>
                            <select id="txn-type" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="buy">Buy</option>
                                <option value="sell">Sell</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Stock Symbol</label>
                            <input type="text" id="txn-symbol" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., RELIANCE, TCS, INFY">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Exchange</label>
                            <select id="txn-exchange" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="NSE">NSE</option>
                                <option value="BSE">BSE</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Quantity</label>
                            <input type="number" id="txn-quantity" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Number of shares">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Price per Share (‚Çπ)</label>
                            <input type="number" step="0.01" id="txn-price" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Price in INR">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Transaction Date</label>
                            <input type="date" id="txn-date" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Tags (comma-separated)</label>
                            <input type="text" id="txn-tags" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., Growth, Value, Dividend">
                        </div>
                    </div>
                    <button onclick="addTransaction()" class="mt-4 px-6 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">Add Transaction</button>
                </div>

                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-xl font-semibold mb-4">Transaction History</h2>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Investor</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Type</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Symbol</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Quantity</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Price</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Total</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tags</th>
                                </tr>
                            </thead>
                            <tbody id="transactions-list" class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Portfolio Tab -->
            <div id="portfolio-tab" class="tab-content hidden">
                <div class="bg-white rounded-lg shadow p-6 mb-6">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 gap-4">
                        <h2 class="text-xl font-semibold">Portfolio Holdings</h2>
                        <div class="flex gap-2">
                            <button onclick="manualPriceUpdate()" class="px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 text-sm">
                                ‚úèÔ∏è Update Prices
                            </button>
                            <button onclick="refreshPrices()" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 text-sm">
                                <span id="refresh-btn-text">üîÑ Refresh Prices</span>
                            </button>
                        </div>
                    </div>
                    <div class="mb-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Filter by Investor</label>
                            <select id="portfolio-investor-filter" onchange="renderPortfolio()" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                <option value="">All Investors</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Filter by Tag</label>
                            <select id="portfolio-tag-filter" onchange="renderPortfolio()" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                <option value="">All Tags</option>
                            </select>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Investor</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Symbol</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Quantity</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Avg Cost</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Current Price</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Total Value</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">P&L</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">P&L %</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tags</th>
                                </tr>
                            </thead>
                            <tbody id="portfolio-list" class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                    <div id="portfolio-summary" class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4"></div>
                </div>
            </div>

            <!-- Reports Tab -->
            <div id="reports-tab" class="tab-content hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="text-lg font-semibold mb-4">Portfolio Value by Investor</h3>
                        <canvas id="investorChart"></canvas>
                    </div>
                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="text-lg font-semibold mb-4">Portfolio Allocation by Stock</h3>
                        <canvas id="stockChart"></canvas>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="text-lg font-semibold mb-4">Top Gainers</h3>
                        <div id="top-gainers" class="space-y-2"></div>
                    </div>
                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="text-lg font-semibold mb-4">Top Losers</h3>
                        <div id="top-losers" class="space-y-2"></div>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow p-6 mt-6">
                    <h3 class="text-lg font-semibold mb-4">Portfolio by Tags</h3>
                    <canvas id="tagsChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Manual Price Update Modal -->
    <div id="price-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[80vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold">Update Stock Prices</h3>
                <button onclick="closePriceModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <div id="price-inputs" class="space-y-3"></div>
            <div class="mt-6 flex justify-end gap-2">
                <button onclick="closePriceModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400">Cancel</button>
                <button onclick="savePrices()" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Save Prices</button>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const SPREADSHEET_ID = '12374EPO21QqqnCQIM55YYRL47Cfr08TYTKAHOqRF_9s';
        const CLIENT_ID = '532356363741-7qik6g6ajrs5s7j68gujk9jmkambujag.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyDV76uCUmC58qigHVfn8ako1OBJCDmVhkM';
        const DISCOVERY_DOC = 'https://sheets.googleapis.com/$discovery/rest?version=v4';
        const SCOPES = 'https://www.googleapis.com/auth/spreadsheets';

        // Data storage
        let investors = [];
        let transactions = [];
        let currentPrices = {};
        let tokenClient;
        let gapiInited = false;
        let gisInited = false;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('txn-date').value = today;
            
            // Load Google API
            gapiLoaded();
            gisLoaded();
        });

        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }

        async function initializeGapiClient() {
            await gapi.client.init({
                apiKey: API_KEY,
                discoveryDocs: [DISCOVERY_DOC],
            });
            gapiInited = true;
            maybeEnableButtons();
        }

        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: '', // defined later
            });
            gisInited = true;
            maybeEnableButtons();
        }

        function maybeEnableButtons() {
            if (gapiInited && gisInited) {
                document.getElementById('loading-section').classList.add('hidden');
                document.getElementById('auth-section').classList.remove('hidden');
                document.getElementById('authorize-button').onclick = handleAuthClick;
                document.getElementById('signout-button').onclick = handleSignoutClick;
            }
        }

        // Add timeout to show error if APIs don't load
        setTimeout(() => {
            if (!gapiInited || !gisInited) {
                document.getElementById('loading-section').classList.add('hidden');
                document.getElementById('auth-section').classList.remove('hidden');
                document.getElementById('error-msg').textContent = 
                    '‚ö†Ô∏è Error loading Google APIs. Please check your internet connection and refresh the page.';
            }
        }, 10000);

        function handleAuthClick() {
            tokenClient.callback = async (resp) => {
                if (resp.error !== undefined) {
                    throw (resp);
                }
                document.getElementById('auth-section').classList.add('hidden');
                document.getElementById('main-app').classList.remove('hidden');
                await initializeSheets();
                await loadData();
                showTab('investors');
            };

            if (gapi.client.getToken() === null) {
                tokenClient.requestAccessToken({prompt: 'consent'});
            } else {
                tokenClient.requestAccessToken({prompt: ''});
            }
        }

        function handleSignoutClick() {
            const token = gapi.client.getToken();
            if (token !== null) {
                google.accounts.oauth2.revoke(token.access_token);
                gapi.client.setToken('');
                document.getElementById('main-app').classList.add('hidden');
                document.getElementById('auth-section').classList.remove('hidden');
            }
        }

        async function initializeSheets() {
            try {
                // Check if sheets exist, if not create them
                const response = await gapi.client.sheets.spreadsheets.get({
                    spreadsheetId: SPREADSHEET_ID,
                });

                const sheetNames = response.result.sheets.map(sheet => sheet.properties.title);
                
                const requiredSheets = ['Investors', 'Transactions', 'CurrentPrices'];
                const missingSheets = requiredSheets.filter(name => !sheetNames.includes(name));

                if (missingSheets.length > 0) {
                    await createMissingSheets(missingSheets);
                }

                // Initialize headers
                await initializeHeaders();
            } catch (err) {
                console.error('Error initializing sheets:', err);
                alert('Error setting up Google Sheets. Please check console for details.');
            }
        }

        async function createMissingSheets(sheetNames) {
            const requests = sheetNames.map(name => ({
                addSheet: {
                    properties: {
                        title: name
                    }
                }
            }));

            await gapi.client.sheets.spreadsheets.batchUpdate({
                spreadsheetId: SPREADSHEET_ID,
                resource: { requests }
            });
        }

        async function initializeHeaders() {
            const updates = [
                {
                    range: 'Investors!A1:D1',
                    values: [['Name', 'PAN', 'ID', 'Created At']]
                },
                {
                    range: 'Transactions!A1:M1',
                    values: [['Date', 'Investor Name', 'Investor PAN', 'Investor ID', 'Type', 'Symbol', 'Exchange', 'Quantity', 'Price', 'Total', 'Tags', 'Transaction ID', 'Created At']]
                },
                {
                    range: 'CurrentPrices!A1:B1',
                    values: [['Symbol', 'Price']]
                }
            ];

            for (const update of updates) {
                try {
                    await gapi.client.sheets.spreadsheets.values.update({
                        spreadsheetId: SPREADSHEET_ID,
                        range: update.range,
                        valueInputOption: 'RAW',
                        resource: { values: update.values }
                    });
                } catch (err) {
                    // Headers might already exist
                    console.log('Headers might already exist:', err);
                }
            }
        }

        async function loadData() {
            try {
                // Load Investors
                const investorsResponse = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: SPREADSHEET_ID,
                    range: 'Investors!A2:D',
                });
                const investorsRows = investorsResponse.result.values || [];
                investors = investorsRows.map(row => ({
                    name: row[0] || '',
                    pan: row[1] || '',
                    id: row[2] || '',
                    createdAt: row[3] || ''
                }));

                // Load Transactions
                const transactionsResponse = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: SPREADSHEET_ID,
                    range: 'Transactions!A2:M',
                });
                const transactionsRows = transactionsResponse.result.values || [];
                transactions = transactionsRows.map(row => ({
                    date: row[0] || '',
                    investorName: row[1] || '',
                    investorPAN: row[2] || '',
                    investorId: row[3] || '',
                    type: row[4] || '',
                    symbol: row[5] || '',
                    exchange: row[6] || '',
                    quantity: parseFloat(row[7]) || 0,
                    price: parseFloat(row[8]) || 0,
                    total: parseFloat(row[9]) || 0,
                    tags: row[10] ? row[10].split(',').map(t => t.trim()) : [],
                    id: row[11] || '',
                    createdAt: row[12] || ''
                }));

                // Load Current Prices
                const pricesResponse = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: SPREADSHEET_ID,
                    range: 'CurrentPrices!A2:B',
                });
                const pricesRows = pricesResponse.result.values || [];
                currentPrices = {};
                pricesRows.forEach(row => {
                    if (row[0] && row[1]) {
                        currentPrices[row[0]] = parseFloat(row[1]);
                    }
                });

                renderInvestors();
                renderTransactions();
                updateInvestorDropdowns();
            } catch (err) {
                console.error('Error loading data:', err);
                alert('Error loading data from Google Sheets');
            }
        }

        async function syncData() {
            try {
                await loadData();
                alert('‚úì Data synced successfully!');
            } catch (err) {
                console.error('Sync error:', err);
                alert('Error syncing data');
            }
        }

        async function saveInvestors() {
            const values = investors.map(inv => [inv.name, inv.pan, inv.id, inv.createdAt]);
            
            await gapi.client.sheets.spreadsheets.values.update({
                spreadsheetId: SPREADSHEET_ID,
                range: 'Investors!A2:D',
                valueInputOption: 'RAW',
                resource: { values }
            });
        }

        async function saveTransactions() {
            const values = transactions.map(txn => [
                txn.date,
                txn.investorName,
                txn.investorPAN,
                txn.investorId,
                txn.type,
                txn.symbol,
                txn.exchange,
                Math.abs(txn.quantity),
                txn.price,
                txn.total,
                txn.tags.join(', '),
                txn.id,
                txn.createdAt
            ]);
            
            await gapi.client.sheets.spreadsheets.values.update({
                spreadsheetId: SPREADSHEET_ID,
                range: 'Transactions!A2:M',
                valueInputOption: 'RAW',
                resource: { values }
            });
        }

        async function saveCurrentPrices() {
            const values = Object.entries(currentPrices).map(([symbol, price]) => [symbol, price]);
            
            await gapi.client.sheets.spreadsheets.values.update({
                spreadsheetId: SPREADSHEET_ID,
                range: 'CurrentPrices!A2:B',
                valueInputOption: 'RAW',
                resource: { values }
            });
        }

        // Tab switching
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('bg-blue-600', 'text-white');
                btn.classList.add('text-gray-600', 'hover:bg-gray-100');
            });
            
            document.getElementById(`${tabName}-tab`).classList.remove('hidden');
            document.getElementById(`tab-${tabName}`).classList.add('bg-blue-600', 'text-white');
            document.getElementById(`tab-${tabName}`).classList.remove('text-gray-600', 'hover:bg-gray-100');

            if (tabName === 'portfolio') {
                renderPortfolio();
            } else if (tabName === 'reports') {
                renderReports();
            }
        }

        // Investor Management
        async function addInvestor() {
            const name = document.getElementById('investor-name').value.trim();
            const pan = document.getElementById('investor-pan').value.trim().toUpperCase();

            if (!name || !pan) {
                alert('Please enter both name and PAN number');
                return;
            }

            if (!/^[A-Z]{5}[0-9]{4}[A-Z]$/.test(pan)) {
                alert('Invalid PAN format. Format should be: ABCDE1234F');
                return;
            }

            if (investors.find(inv => inv.pan === pan)) {
                alert('Investor with this PAN already exists');
                return;
            }

            const investor = {
                id: Date.now().toString(),
                name,
                pan,
                createdAt: new Date().toISOString()
            };

            investors.push(investor);
            await saveInvestors();
            
            document.getElementById('investor-name').value = '';
            document.getElementById('investor-pan').value = '';
            
            renderInvestors();
            updateInvestorDropdowns();
            alert('Investor added successfully!');
        }

        function renderInvestors() {
            const list = document.getElementById('investors-list');
            if (investors.length === 0) {
                list.innerHTML = '<p class="text-gray-500">No investors registered yet.</p>';
                return;
            }

            list.innerHTML = investors.map(inv => `
                <div class="flex justify-between items-center p-4 border border-gray-200 rounded-md hover:bg-gray-50">
                    <div>
                        <p class="font-medium text-gray-800">${inv.name}</p>
                        <p class="text-sm text-gray-500">PAN: ${inv.pan}</p>
                    </div>
                </div>
            `).join('');
        }

        function updateInvestorDropdowns() {
            const txnSelect = document.getElementById('txn-investor');
            const portfolioFilter = document.getElementById('portfolio-investor-filter');
            
            const options = investors.map(inv => 
                `<option value="${inv.id}">${inv.name} (${inv.pan})</option>`
            ).join('');
            
            txnSelect.innerHTML = '<option value="">Select investor...</option>' + options;
            portfolioFilter.innerHTML = '<option value="">All Investors</option>' + options;
        }

        // Transaction Management
        async function addTransaction() {
            const investorId = document.getElementById('txn-investor').value;
            const type = document.getElementById('txn-type').value;
            const symbol = document.getElementById('txn-symbol').value.trim().toUpperCase();
            const exchange = document.getElementById('txn-exchange').value;
            const quantity = parseFloat(document.getElementById('txn-quantity').value);
            const price = parseFloat(document.getElementById('txn-price').value);
            const date = document.getElementById('txn-date').value;
            const tags = document.getElementById('txn-tags').value.trim();

            if (!investorId || !symbol || !quantity || !price || !date) {
                alert('Please fill in all required fields');
                return;
            }

            const investor = investors.find(inv => inv.id === investorId);
            const transaction = {
                id: Date.now().toString(),
                investorId,
                investorName: investor.name,
                investorPAN: investor.pan,
                type,
                symbol,
                exchange,
                quantity: type === 'sell' ? -quantity : quantity,
                price,
                total: quantity * price,
                date,
                tags: tags ? tags.split(',').map(t => t.trim()).filter(t => t) : [],
                createdAt: new Date().toISOString()
            };

            transactions.push(transaction);
            await saveTransactions();
            
            document.getElementById('txn-symbol').value = '';
            document.getElementById('txn-quantity').value = '';
            document.getElementById('txn-price').value = '';
            document.getElementById('txn-tags').value = '';
            
            renderTransactions();
            alert('Transaction added successfully!');
        }

        function renderTransactions() {
            const list = document.getElementById('transactions-list');
            if (transactions.length === 0) {
                list.innerHTML = '<tr><td colspan="8" class="px-4 py-8 text-center text-gray-500">No transactions yet.</td></tr>';
                return;
            }

            const sorted = [...transactions].sort((a, b) => new Date(b.date) - new Date(a.date));
            list.innerHTML = sorted.map(txn => `
                <tr class="hover:bg-gray-50">
                    <td class="px-4 py-3 text-sm text-gray-900">${formatDate(txn.date)}</td>
                    <td class="px-4 py-3 text-sm text-gray-900">${txn.investorName}</td>
                    <td class="px-4 py-3 text-sm">
                        <span class="px-2 py-1 text-xs rounded-full ${txn.type === 'buy' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                            ${txn.type.toUpperCase()}
                        </span>
                    </td>
                    <td class="px-4 py-3 text-sm font-medium text-gray-900">${txn.symbol} (${txn.exchange})</td>
                    <td class="px-4 py-3 text-sm text-gray-900">${Math.abs(txn.quantity)}</td>
                    <td class="px-4 py-3 text-sm text-gray-900">‚Çπ${txn.price.toFixed(2)}</td>
                    <td class="px-4 py-3 text-sm font-medium text-gray-900">‚Çπ${txn.total.toFixed(2)}</td>
                    <td class="px-4 py-3 text-sm text-gray-600">
                        ${txn.tags.map(tag => `<span class="inline-block px-2 py-1 text-xs bg-blue-100 text-blue-800 rounded mr-1 mb-1">${tag}</span>`).join('')}
                    </td>
                </tr>
            `).join('');
        }

        // Price Management
        function manualPriceUpdate() {
            const holdings = calculateHoldings();
            if (holdings.length === 0) {
                alert('No holdings to update prices for.');
                return;
            }

            const symbols = [...new Set(holdings.map(h => h.symbol))];
            const modal = document.getElementById('price-modal');
            const inputs = document.getElementById('price-inputs');
            
            inputs.innerHTML = symbols.map(symbol => {
                const currentPrice = currentPrices[symbol] || holdings.find(h => h.symbol === symbol).avgCost;
                return `
                    <div class="flex items-center gap-4">
                        <label class="w-32 font-medium text-gray-700">${symbol}:</label>
                        <div class="flex-1">
                            <input type="number" step="0.01" id="price-${symbol}" value="${currentPrice.toFixed(2)}" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   placeholder="Enter price in ‚Çπ">
                        </div>
                    </div>
                `;
            }).join('');
            
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closePriceModal() {
            const modal = document.getElementById('price-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        async function savePrices() {
            const holdings = calculateHoldings();
            const symbols = [...new Set(holdings.map(h => h.symbol))];
            
            symbols.forEach(symbol => {
                const input = document.getElementById(`price-${symbol}`);
                if (input && input.value) {
                    currentPrices[symbol] = parseFloat(input.value);
                }
            });
            
            await saveCurrentPrices();
            closePriceModal();
            renderPortfolio();
            alert('Prices updated successfully!');
        }

        async function refreshPrices() {
            const btn = document.getElementById('refresh-btn-text');
            btn.textContent = 'Refreshing...';
            
            const holdings = calculateHoldings();
            const symbols = [...new Set(holdings.map(h => h.symbol))];
            
            let successCount = 0;
            let failCount = 0;
            
            const API_BASE = 'https://military-jobye-haiqstudios-14f59639.koyeb.app';
            
            for (const symbol of symbols) {
                try {
                    const exchange = holdings.find(h => h.symbol === symbol).exchange;
                    const suffix = exchange === 'NSE' ? '.NS' : '.BO';
                    
                    const response = await fetch(`${API_BASE}/stock?symbol=${symbol}${suffix}`, {
                        method: 'GET',
                        headers: { 'Accept': 'application/json' }
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    if (data.status === 'success' && data.data) {
                        const price = data.data.current_price || data.data.last_price || data.data.lastPrice || data.data.lp;
                        
                        if (price) {
                            currentPrices[symbol] = parseFloat(price);
                            successCount++;
                        } else {
                            failCount++;
                        }
                    } else {
                        failCount++;
                    }
                } catch (error) {
                    failCount++;
                }
                
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            
            if (successCount > 0) {
                await saveCurrentPrices();
            }
            
            btn.textContent = 'üîÑ Refresh Prices';
            
            if (successCount > 0) {
                alert(`Prices updated!\n\nSuccessful: ${successCount}\nFailed: ${failCount}`);
            } else {
                alert(`Unable to fetch live prices. Use "Update Prices" button to enter manually.`);
            }
            
            renderPortfolio();
        }

        // Portfolio Management  
        function calculateHoldings() {
            const holdings = {};
            
            transactions.forEach(txn => {
                const key = `${txn.investorId}-${txn.symbol}-${txn.exchange}`;
                
                if (!holdings[key]) {
                    holdings[key] = {
                        investorId: txn.investorId,
                        investorName: txn.investorName,
                        symbol: txn.symbol,
                        exchange: txn.exchange,
                        quantity: 0,
                        totalCost: 0,
                        tags: new Set()
                    };
                }
                
                holdings[key].quantity += txn.quantity;
                holdings[key].totalCost += (txn.quantity * txn.price);
                txn.tags.forEach(tag => holdings[key].tags.add(tag));
            });
            
            return Object.values(holdings)
                .filter(h => h.quantity > 0)
                .map(h => ({
                    ...h,
                    avgCost: h.totalCost / h.quantity,
                    tags: Array.from(h.tags)
                }));
        }

        function renderPortfolio() {
            const list = document.getElementById('portfolio-list');
            const investorFilter = document.getElementById('portfolio-investor-filter').value;
            const tagFilter = document.getElementById('portfolio-tag-filter').value;
            
            let holdings = calculateHoldings();
            
            if (investorFilter) {
                holdings = holdings.filter(h => h.investorId === investorFilter);
            }
            
            if (tagFilter) {
                holdings = holdings.filter(h => h.tags.includes(tagFilter));
            }
            
            updateTagFilter();
            
            if (holdings.length === 0) {
                list.innerHTML = '<tr><td colspan="9" class="px-4 py-8 text-center text-gray-500">No holdings to display.</td></tr>';
                document.getElementById('portfolio-summary').innerHTML = '';
                return;
            }

            let totalInvested = 0;
            let totalValue = 0;
            
            list.innerHTML = holdings.map(holding => {
                const currentPrice = currentPrices[holding.symbol] || holding.avgCost;
                const currentValue = holding.quantity * currentPrice;
                const totalCost = holding.quantity * holding.avgCost;
                const pl = currentValue - totalCost;
                const plPercent = (pl / totalCost) * 100;
                
                totalInvested += totalCost;
                totalValue += currentValue;
                
                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3 text-sm text-gray-900">${holding.investorName}</td>
                        <td class="px-4 py-3 text-sm font-medium text-gray-900">${holding.symbol} (${holding.exchange})</td>
                        <td class="px-4 py-3 text-sm text-gray-900">${holding.quantity}</td>
                        <td class="px-4 py-3 text-sm text-gray-900">‚Çπ${holding.avgCost.toFixed(2)}</td>
                        <td class="px-4 py-3 text-sm text-gray-900">‚Çπ${currentPrice.toFixed(2)}</td>
                        <td class="px-4 py-3 text-sm font-medium text-gray-900">‚Çπ${currentValue.toFixed(2)}</td>
                        <td class="px-4 py-3 text-sm ${pl >= 0 ? 'text-green-600' : 'text-red-600'} font-medium">
                            ${pl >= 0 ? '+' : ''}‚Çπ${pl.toFixed(2)}
                        </td>
                        <td class="px-4 py-3 text-sm ${plPercent >= 0 ? 'text-green-600' : 'text-red-600'} font-medium">
                            ${plPercent >= 0 ? '+' : ''}${plPercent.toFixed(2)}%
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-600">
                            ${holding.tags.map(tag => `<span class="inline-block px-2 py-1 text-xs bg-blue-100 text-blue-800 rounded mr-1 mb-1">${tag}</span>`).join('')}
                        </td>
                    </tr>
                `;
            }).join('');
            
            const totalPL = totalValue - totalInvested;
            const totalPLPercent = totalInvested > 0 ? (totalPL / totalInvested) * 100 : 0;
            
            document.getElementById('portfolio-summary').innerHTML = `
                <div class="bg-blue-50 p-4 rounded-lg">
                    <p class="text-sm text-gray-600 mb-1">Total Invested</p>
                    <p class="text-2xl font-bold text-gray-900">‚Çπ${totalInvested.toLocaleString('en-IN', {maximumFractionDigits: 2})}</p>
                </div>
                <div class="bg-green-50 p-4 rounded-lg">
                    <p class="text-sm text-gray-600 mb-1">Current Value</p>
                    <p class="text-2xl font-bold text-gray-900">‚Çπ${totalValue.toLocaleString('en-IN', {maximumFractionDigits: 2})}</p>
                </div>
                <div class="${totalPL >= 0 ? 'bg-green-50' : 'bg-red-50'} p-4 rounded-lg">
                    <p class="text-sm text-gray-600 mb-1">Total P&L</p>
                    <p class="text-2xl font-bold ${totalPL >= 0 ? 'text-green-600' : 'text-red-600'}">
                        ${totalPL >= 0 ? '+' : ''}‚Çπ${totalPL.toLocaleString('en-IN', {maximumFractionDigits: 2})} (${totalPLPercent >= 0 ? '+' : ''}${totalPLPercent.toFixed(2)}%)
                    </p>
                </div>
            `;
        }

        function updateTagFilter() {
            const allTags = new Set();
            transactions.forEach(txn => txn.tags.forEach(tag => allTags.add(tag)));
            
            const tagFilter = document.getElementById('portfolio-tag-filter');
            const currentValue = tagFilter.value;
            
            tagFilter.innerHTML = '<option value="">All Tags</option>' + 
                Array.from(allTags).sort().map(tag => 
                    `<option value="${tag}" ${tag === currentValue ? 'selected' : ''}>${tag}</option>`
                ).join('');
        }

        // Reports (simplified for now - will add charts functionality)
        function renderReports() {
            const holdings = calculateHoldings();
            
            if (holdings.length === 0) {
                document.getElementById('investorChart').parentElement.innerHTML = 
                    '<p class="text-gray-500 text-center py-8">No data available for reports</p>';
                return;
            }
            
            renderInvestorChart(holdings);
            renderStockChart(holdings);
            renderTagsChart(holdings);
            renderTopGainersLosers(holdings);
        }

        function renderInvestorChart(holdings) {
            const investorValues = {};
            holdings.forEach(h => {
                const value = h.quantity * (currentPrices[h.symbol] || h.avgCost);
                investorValues[h.investorName] = (investorValues[h.investorName] || 0) + value;
            });
            
            const ctx = document.getElementById('investorChart');
            if (window.investorChartInstance) window.investorChartInstance.destroy();
            
            window.investorChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(investorValues),
                    datasets: [{
                        data: Object.values(investorValues),
                        backgroundColor: ['#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6', '#EC4899']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'bottom' },
                        tooltip: {
                            callbacks: {
                                label: (context) => {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    return `${label}: ‚Çπ${value.toLocaleString('en-IN', {maximumFractionDigits: 2})}`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderStockChart(holdings) {
            const stockValues = {};
            holdings.forEach(h => {
                const value = h.quantity * (currentPrices[h.symbol] || h.avgCost);
                stockValues[h.symbol] = (stockValues[h.symbol] || 0) + value;
            });
            
            const sortedStocks = Object.entries(stockValues)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            
            const ctx = document.getElementById('stockChart');
            if (window.stockChartInstance) window.stockChartInstance.destroy();
            
            window.stockChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedStocks.map(s => s[0]),
                    datasets: [{
                        label: 'Portfolio Value (‚Çπ)',
                        data: sortedStocks.map(s => s[1]),
                        backgroundColor: '#3B82F6'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: (value) => '‚Çπ' + value.toLocaleString('en-IN')
                            }
                        }
                    }
                }
            });
        }

        function renderTagsChart(holdings) {
            const tagValues = {};
            holdings.forEach(h => {
                const value = h.quantity * (currentPrices[h.symbol] || h.avgCost);
                h.tags.forEach(tag => {
                    tagValues[tag] = (tagValues[tag] || 0) + value;
                });
            });
            
            if (Object.keys(tagValues).length === 0) {
                document.getElementById('tagsChart').parentElement.innerHTML = 
                    '<p class="text-gray-500 text-center py-8">No tags data available</p>';
                return;
            }
            
            const ctx = document.getElementById('tagsChart');
            if (window.tagsChartInstance) window.tagsChartInstance.destroy();
            
            window.tagsChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(tagValues),
                    datasets: [{
                        label: 'Portfolio Value by Tag (‚Çπ)',
                        data: Object.values(tagValues),
                        backgroundColor: '#10B981'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: (value) => '‚Çπ' + value.toLocaleString('en-IN')
                            }
                        }
                    }
                }
            });
        }

        function renderTopGainersLosers(holdings) {
            const withPL = holdings.map(h => {
                const currentPrice = currentPrices[h.symbol] || h.avgCost;
                const pl = ((currentPrice - h.avgCost) / h.avgCost) * 100;
                return { ...h, plPercent: pl };
            });
            
            const gainers = withPL.filter(h => h.plPercent > 0)
                .sort((a, b) => b.plPercent - a.plPercent)
                .slice(0, 5);
            
            const losers = withPL.filter(h => h.plPercent < 0)
                .sort((a, b) => a.plPercent - b.plPercent)
                .slice(0, 5);
            
            document.getElementById('top-gainers').innerHTML = gainers.length > 0 
                ? gainers.map(h => `
                    <div class="flex justify-between items-center p-3 bg-green-50 rounded">
                        <div>
                            <p class="font-medium text-gray-800">${h.symbol}</p>
                            <p class="text-sm text-gray-600">${h.investorName}</p>
                        </div>
                        <p class="text-green-600 font-medium">+${h.plPercent.toFixed(2)}%</p>
                    </div>
                `).join('')
                : '<p class="text-gray-500 text-sm">No gainers yet</p>';
            
            document.getElementById('top-losers').innerHTML = losers.length > 0
                ? losers.map(h => `
                    <div class="flex justify-between items-center p-3 bg-red-50 rounded">
                        <div>
                            <p class="font-medium text-gray-800">${h.symbol}</p>
                            <p class="text-sm text-gray-600">${h.investorName}</p>
                        </div>
                        <p class="text-red-600 font-medium">${h.plPercent.toFixed(2)}%</p>
                    </div>
                `).join('')
                : '<p class="text-gray-500 text-sm">No losers yet</p>';
        }

        // Utilities
        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' });
        }
    </script>
</body>
</html>