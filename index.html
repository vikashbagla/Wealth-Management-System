<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wealth Management Platform</title>
    <!-- Supabase JavaScript Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        
        header { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        header h1 { font-size: 28px; color: #333; margin-bottom: 5px; }
        header p { color: #666; font-size: 14px; }
        header .header-actions { display: flex; gap: 10px; margin-top: 15px; }
        header .header-actions .btn { font-size: 13px; padding: 8px 16px; }
        
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #e0e0e0; padding-bottom: 0; }
        .tab-btn { padding: 12px 24px; border: none; background: none; cursor: pointer; font-size: 15px; color: #666; border-bottom: 3px solid transparent; margin-bottom: -2px; }
        .tab-btn.active { color: #2563eb; border-bottom-color: #2563eb; font-weight: 600; }
        .tab-btn:hover { color: #2563eb; }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .card { background: white; padding: 24px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .card h2 { font-size: 20px; margin-bottom: 16px; color: #333; }
        
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; margin-bottom: 16px; }
        .form-group label { display: block; font-size: 14px; font-weight: 500; color: #555; margin-bottom: 6px; }
        .form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: #2563eb; }
        
        .btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500; }
        .btn-primary { background: #2563eb; color: white; }
        .btn-primary:hover { background: #1d4ed8; }
        .btn-success { background: #10b981; color: white; }
        .btn-success:hover { background: #059669; }
        
        table { width: 100%; border-collapse: collapse; }
        th { background: #e5e7eb; padding: 12px; text-align: left; font-size: 12px; font-weight: 600; color: #374151; text-transform: uppercase; border-bottom: 2px solid #9ca3af; position: sticky; top: 0; z-index: 10; cursor: pointer; }
        th:hover { background: #d1d5db; }
        th.text-right { text-align: right; }
        td { padding: 12px; border-bottom: 1px solid #e5e7eb; font-size: 14px; }
        td.text-right { text-align: right; }
        tr:hover { background: #f9fafb; }
        tr.total-row { background: #f3f4f6; font-weight: 600; font-size: 12px; border-bottom: 3px solid #9ca3af; position: sticky; top: 41px; z-index: 9; }
        tr.total-row td { text-transform: uppercase; color: #374151; }
        tr.total-row:hover { background: #f3f4f6; }
        tr.expanded-row { background: #fef3c7; }
        tr.expanded-row:hover { background: #fef3c7; }
        tr.detail-row { background: #fffbeb; }
        tr.detail-row td { padding: 0; }
        tr.detail-row table { margin: 0; }
        tr.detail-row .inner-table { width: 100%; font-size: 13px; table-layout: fixed; }
        tr.detail-row .inner-table th { background: #fef3c7; font-size: 11px; padding: 8px; }
        tr.detail-row .inner-table td { padding: 8px 12px; border-bottom: 1px solid #fde68a; }
        tr.detail-row .inner-table td:nth-child(1) { width: 16%; } /* Investor */
        tr.detail-row .inner-table td:nth-child(2) { width: 12%; } /* Qty */
        tr.detail-row .inner-table td:nth-child(3) { width: 16%; } /* Invested Value */
        tr.detail-row .inner-table td:nth-child(4) { width: 14%; } /* Current Price */
        tr.detail-row .inner-table td:nth-child(5) { width: 14%; } /* P&L */
        tr.detail-row .inner-table td:nth-child(6) { width: 14%; } /* Value */
        tr.detail-row .inner-table td:nth-child(7) { width: 14%; } /* Tags */
        .table-container { max-height: 600px; overflow-y: auto; overflow-x: auto; position: relative; }
        .table-container > table { table-layout: fixed; width: 100%; min-width: 1000px; }
        .table-container > table th:nth-child(1), 
        .table-container > table td:nth-child(1) { width: 16%; } /* Symbol */
        .table-container > table th:nth-child(2), 
        .table-container > table td:nth-child(2) { width: 12%; } /* Qty */
        .table-container > table th:nth-child(3), 
        .table-container > table td:nth-child(3) { width: 16%; } /* Invested Value */
        .table-container > table th:nth-child(4), 
        .table-container > table td:nth-child(4) { width: 14%; } /* Current Price */
        .table-container > table th:nth-child(5), 
        .table-container > table td:nth-child(5) { width: 14%; } /* P&L */
        .table-container > table th:nth-child(6), 
        .table-container > table td:nth-child(6) { width: 14%; } /* Value */
        .table-container > table th:nth-child(7), 
        .table-container > table td:nth-child(7) { width: 14%; } /* Tags */
        .sort-indicator { font-size: 10px; margin-left: 4px; }
        .symbol-clickable { cursor: pointer; color: #2563eb; }
        .symbol-clickable:hover { text-decoration: underline; }
        
        .filter-search-container { position: relative; }
        .filter-search-input { 
            width: 100%; 
            padding: 8px; 
            border: 1px solid #ddd; 
            border-radius: 6px; 
            font-size: 14px;
        }
        .filter-search-input:focus { outline: none; border-color: #2563eb; }
        .filter-selected-tags { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 6px; 
            margin-top: 8px; 
            min-height: 32px;
        }
        .filter-tag-item { 
            display: inline-flex; 
            align-items: center; 
            padding: 4px 8px; 
            background: #2563eb; 
            color: white; 
            border-radius: 4px; 
            font-size: 13px;
            gap: 6px;
        }
        .filter-tag-remove { 
            cursor: pointer; 
            font-weight: bold; 
            font-size: 16px;
            line-height: 1;
        }
        .filter-tag-remove:hover { color: #fee2e2; }
        .filter-dropdown { 
            position: absolute; 
            top: 100%; 
            left: 0; 
            right: 0; 
            background: white; 
            border: 1px solid #ddd; 
            border-radius: 6px; 
            max-height: 300px; 
            overflow-y: auto; 
            z-index: 100;
            margin-top: 4px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: none;
            padding: 8px;
        }
        .filter-dropdown.show { display: flex; flex-wrap: wrap; gap: 6px; align-content: flex-start; }
        .filter-dropdown-item { 
            padding: 6px 12px; 
            cursor: pointer; 
            font-size: 13px;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            background: white;
            transition: all 0.15s;
            flex-shrink: 0;
        }
        .filter-dropdown-item:hover { background: #f3f4f6; border-color: #d1d5db; }
        .filter-dropdown-item.selected { 
            background: #dbeafe; 
            color: #1e40af;
            font-weight: 600;
            border-color: #93c5fd;
        }
        .filter-dropdown-item.selected:hover { background: #bfdbfe; border-color: #60a5fa; }
        .filter-dropdown-empty { 
            padding: 12px; 
            color: #999; 
            text-align: center; 
            font-size: 13px;
            width: 100%;
        }
        
        .badge { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; }
        .badge-buy { background: #d1fae5; color: #065f46; }
        .badge-sell { background: #fee2e2; color: #991b1b; }
        .tag { display: inline-block; padding: 3px 8px; background: #dbeafe; color: #1e40af; border-radius: 4px; font-size: 11px; margin-right: 4px; margin-bottom: 4px; }
        
        .summary-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-top: 20px; }
        .summary-card { padding: 20px; border-radius: 8px; }
        .summary-card.blue { background: #eff6ff; }
        .summary-card.green { background: #f0fdf4; }
        .summary-card.red { background: #fef2f2; }
        .summary-card p:first-child { font-size: 13px; color: #666; margin-bottom: 8px; }
        .summary-card p:last-child { font-size: 24px; font-weight: 700; }
        
        .text-green { color: #10b981; }
        .text-red { color: #ef4444; }
        
        .empty-state { text-align: center; padding: 40px; color: #999; }
        
        .action-buttons { display: flex; gap: 10px; margin-bottom: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Wealth Management Platform</h1>
            <p>Multi-investor portfolio & investment tracking for Indian equities ‚Ä¢ <span id="db-status" style="color: #10b981;">üìä Phase 1: Supabase Testing</span></p>
            <div class="header-actions">
                <button class="btn" onclick="showConnectionStatus()" style="background: #8b5cf6; color: white;">üîå Test Supabase</button>
                <input type="file" id="import-file" accept=".json" style="display: none;" onchange="importData(event)">
                <button class="btn btn-success" onclick="document.getElementById('import-file').click()">üì• Restore</button>
                <button class="btn btn-primary" onclick="exportData()">üì§ Backup</button>
                <button class="btn" id="delete-all-btn" style="background: #ef4444; color: white;">üóëÔ∏è Delete All Data</button>
            </div>
        </header>

        <div class="tabs">
            <button class="tab-btn active" onclick="showTab('investors')">Investors</button>
            <button class="tab-btn" onclick="showTab('brokers')">Brokers</button>
            <button class="tab-btn" onclick="showTab('transactions')">Transactions</button>
            <button class="tab-btn" onclick="showTab('portfolio')">Portfolio</button>
        </div>

        <!-- Investors Tab -->
        <div id="investors-tab" class="tab-content active">
            <div class="card">
                <h2 id="investor-form-title">Add New Investor</h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Investor Name *</label>
                        <input type="text" id="investor-name" placeholder="Enter full name">
                    </div>
                    <div class="form-group">
                        <label>PAN Number *</label>
                        <input type="text" id="investor-pan" placeholder="ABCDE1234F" maxlength="10" style="text-transform: uppercase;">
                        <small style="color: #666; font-size: 12px;">Must be unique</small>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="addInvestor()" style="margin-top: 16px;">Add Investor</button>
            </div>

            <div class="card">
                <h2>Registered Investors</h2>
                <div id="investors-list"></div>
            </div>
        </div>

        <!-- Add/Edit Broker for Investor Modal -->
        <div id="investor-broker-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; overflow-y: auto;">
            <div style="max-width: 800px; margin: 50px auto; background: white; border-radius: 12px; padding: 24px; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 id="broker-modal-title" style="margin: 0;">Add Broker for Investor</h2>
                    <button onclick="closeBrokerModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
                </div>

                <div style="margin-bottom: 16px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 8px;">Select Broker *</label>
                    <select id="modal-broker-select" onchange="loadModalBrokerBrokerage()" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                        <option value="">Select broker...</option>
                    </select>
                </div>

                <div id="modal-brokerage-section" style="display: none; margin-top: 20px;">
                    <h3 style="font-size: 16px; margin-bottom: 12px;">Customize Brokerage <span style="font-size: 12px; color: #666; font-weight: normal;">(0 = No max limit)</span></h3>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <!-- EQ Delivery -->
                        <div style="border: 1px solid #e5e7eb; padding: 12px; border-radius: 6px;">
                            <h4 style="margin: 0 0 10px 0; font-size: 13px; font-weight: 600; color: #374151;">Equity Delivery</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <div class="form-group" style="margin: 0;">
                                    <label style="font-size: 12px;">% of Value</label>
                                    <input type="number" id="modal-eq-delivery-pct" step="0.01" min="0" value="0" style="padding: 6px;">
                                </div>
                                <div class="form-group" style="margin: 0;">
                                    <label style="font-size: 12px;">Max (‚Çπ)</label>
                                    <input type="number" id="modal-eq-delivery-max" step="1" min="0" value="0" style="padding: 6px;">
                                </div>
                            </div>
                        </div>

                        <!-- EQ Intraday -->
                        <div style="border: 1px solid #e5e7eb; padding: 12px; border-radius: 6px;">
                            <h4 style="margin: 0 0 10px 0; font-size: 13px; font-weight: 600; color: #374151;">Equity Intraday</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <div class="form-group" style="margin: 0;">
                                    <label style="font-size: 12px;">% of Value</label>
                                    <input type="number" id="modal-eq-intraday-pct" step="0.01" min="0" value="0" style="padding: 6px;">
                                </div>
                                <div class="form-group" style="margin: 0;">
                                    <label style="font-size: 12px;">Max (‚Çπ)</label>
                                    <input type="number" id="modal-eq-intraday-max" step="1" min="0" value="0" style="padding: 6px;">
                                </div>
                            </div>
                        </div>

                        <!-- Futures -->
                        <div style="border: 1px solid #e5e7eb; padding: 12px; border-radius: 6px;">
                            <h4 style="margin: 0 0 10px 0; font-size: 13px; font-weight: 600; color: #374151;">Futures</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <div class="form-group" style="margin: 0;">
                                    <label style="font-size: 12px;">% of Value</label>
                                    <input type="number" id="modal-futures-pct" step="0.01" min="0" value="0" style="padding: 6px;">
                                </div>
                                <div class="form-group" style="margin: 0;">
                                    <label style="font-size: 12px;">Max (‚Çπ)</label>
                                    <input type="number" id="modal-futures-max" step="1" min="0" value="0" style="padding: 6px;">
                                </div>
                            </div>
                        </div>

                        <!-- Options -->
                        <div style="border: 1px solid #e5e7eb; padding: 12px; border-radius: 6px;">
                            <h4 style="margin: 0 0 10px 0; font-size: 13px; font-weight: 600; color: #374151;">Options</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <div class="form-group" style="margin: 0;">
                                    <label style="font-size: 12px;">Flat (‚Çπ/lot)</label>
                                    <input type="number" id="modal-options-flat" step="1" min="0" value="0" style="padding: 6px;">
                                </div>
                                <div class="form-group" style="margin: 0;">
                                    <label style="font-size: 12px;">Max (‚Çπ)</label>
                                    <input type="number" id="modal-options-max" step="1" min="0" value="0" style="padding: 6px;">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
                    <button onclick="closeBrokerModal()" class="btn" style="background: #6b7280;">Cancel</button>
                    <button onclick="saveBrokerForInvestor()" class="btn btn-primary">Save Broker</button>
                </div>
            </div>
        </div>

        <!-- F&O Details Modal -->
        <div id="fo-details-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; overflow-y: auto;">
            <div style="max-width: 700px; margin: 100px auto; background: white; border-radius: 12px; padding: 24px; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 id="fo-modal-title" style="margin: 0;">Futures Details</h2>
                    <button onclick="closeFOModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
                </div>

                <!-- Futures Section -->
                <div id="fo-futures-section" style="display: none;">
                    <div style="margin-bottom: 16px; padding: 12px; background: #f3f4f6; border-radius: 6px;">
                        <div style="font-size: 12px; color: #666; margin-bottom: 4px;">Symbol (from main form):</div>
                        <div id="fo-futures-symbol-display" style="font-size: 18px; font-weight: 600; color: #1f2937;">-</div>
                    </div>
                    <div>
                        <label style="display: block; font-weight: 600; margin-bottom: 8px; font-size: 13px;">Expiry *</label>
                        <input type="text" id="fo-futures-expiry" placeholder="30JAN26" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; text-transform: uppercase;">
                        <small style="color: #666; font-size: 11px;">Format: DDMMMYY</small>
                    </div>
                </div>

                <!-- Options Section -->
                <div id="fo-options-section" style="display: none;">
                    <div style="margin-bottom: 16px; padding: 12px; background: #f3f4f6; border-radius: 6px;">
                        <div style="font-size: 12px; color: #666; margin-bottom: 4px;">Symbol (from main form):</div>
                        <div id="fo-options-symbol-display" style="font-size: 18px; font-weight: 600; color: #1f2937;">-</div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px;">
                        <div>
                            <label style="display: block; font-weight: 600; margin-bottom: 8px; font-size: 13px;">Expiry *</label>
                            <input type="text" id="fo-options-expiry" placeholder="30JAN26" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; text-transform: uppercase;">
                            <small style="color: #666; font-size: 11px;">DDMMMYY</small>
                        </div>
                        <div>
                            <label style="display: block; font-weight: 600; margin-bottom: 8px; font-size: 13px;">Type *</label>
                            <input type="text" id="fo-options-type" placeholder="CE" maxlength="2" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; text-transform: uppercase;">
                            <small style="color: #666; font-size: 11px;">CE or PE</small>
                        </div>
                        <div>
                            <label style="display: block; font-weight: 600; margin-bottom: 8px; font-size: 13px;">Strike *</label>
                            <input type="number" step="0.5" id="fo-options-strike" placeholder="18000" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                        </div>
                    </div>
                </div>

                <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
                    <button onclick="closeFOModal()" class="btn" style="background: #6b7280;">Cancel</button>
                    <button onclick="saveFODetails()" class="btn btn-primary">Save Details</button>
                </div>
            </div>
        </div>

        <!-- Brokers Tab -->
        <div id="brokers-tab" class="tab-content">
            <div class="card">
                <h2>Add New Broker</h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Broker Name *</label>
                        <input type="text" id="broker-name" placeholder="Zerodha, Upstox, ICICI Direct">
                    </div>
                </div>
                
                <h3 style="margin: 20px 0 12px 0; font-size: 16px;">Brokerage Rates <span style="font-size: 12px; color: #666; font-weight: normal;">(0 = No max limit)</span></h3>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <!-- EQ Delivery -->
                    <div style="border: 1px solid #e5e7eb; padding: 12px; border-radius: 6px;">
                        <h4 style="margin: 0 0 10px 0; font-size: 13px; font-weight: 600; color: #374151;">Equity Delivery</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <div class="form-group" style="margin: 0;">
                                <label style="font-size: 12px;">% of Value</label>
                                <input type="number" id="broker-eq-delivery-pct" step="0.01" min="0" placeholder="0.25" value="0" style="padding: 6px;">
                            </div>
                            <div class="form-group" style="margin: 0;">
                                <label style="font-size: 12px;">Max (‚Çπ)</label>
                                <input type="number" id="broker-eq-delivery-max" step="1" min="0" placeholder="20" value="0" style="padding: 6px;">
                            </div>
                        </div>
                    </div>

                    <!-- EQ Intraday -->
                    <div style="border: 1px solid #e5e7eb; padding: 12px; border-radius: 6px;">
                        <h4 style="margin: 0 0 10px 0; font-size: 13px; font-weight: 600; color: #374151;">Equity Intraday</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <div class="form-group" style="margin: 0;">
                                <label style="font-size: 12px;">% of Value</label>
                                <input type="number" id="broker-eq-intraday-pct" step="0.01" min="0" placeholder="0.03" value="0" style="padding: 6px;">
                            </div>
                            <div class="form-group" style="margin: 0;">
                                <label style="font-size: 12px;">Max (‚Çπ)</label>
                                <input type="number" id="broker-eq-intraday-max" step="1" min="0" placeholder="20" value="0" style="padding: 6px;">
                            </div>
                        </div>
                    </div>

                    <!-- Futures -->
                    <div style="border: 1px solid #e5e7eb; padding: 12px; border-radius: 6px;">
                        <h4 style="margin: 0 0 10px 0; font-size: 13px; font-weight: 600; color: #374151;">Futures</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <div class="form-group" style="margin: 0;">
                                <label style="font-size: 12px;">% of Value</label>
                                <input type="number" id="broker-futures-pct" step="0.01" min="0" placeholder="0.03" value="0" style="padding: 6px;">
                            </div>
                            <div class="form-group" style="margin: 0;">
                                <label style="font-size: 12px;">Max (‚Çπ)</label>
                                <input type="number" id="broker-futures-max" step="1" min="0" placeholder="20" value="0" style="padding: 6px;">
                            </div>
                        </div>
                    </div>

                    <!-- Options -->
                    <div style="border: 1px solid #e5e7eb; padding: 12px; border-radius: 6px;">
                        <h4 style="margin: 0 0 10px 0; font-size: 13px; font-weight: 600; color: #374151;">Options</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <div class="form-group" style="margin: 0;">
                                <label style="font-size: 12px;">Flat (‚Çπ/lot)</label>
                                <input type="number" id="broker-options-flat" step="1" min="0" placeholder="20" value="0" style="padding: 6px;">
                            </div>
                            <div class="form-group" style="margin: 0;">
                                <label style="font-size: 12px;">Max (‚Çπ)</label>
                                <input type="number" id="broker-options-max" step="1" min="0" placeholder="0" value="0" style="padding: 6px;">
                            </div>
                        </div>
                    </div>
                </div>

                <button class="btn btn-primary" onclick="addBroker()" style="margin-top: 16px;">Add Broker</button>
            </div>

            <div class="card">
                <h2>Registered Brokers</h2>
                <div id="brokers-list"></div>
            </div>

            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <h2 style="margin: 0;">Other Costs (Global Settings)</h2>
                    <button onclick="editOtherCosts()" id="edit-other-costs-btn" style="padding: 6px 16px; background: #f59e0b; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px;">‚úèÔ∏è Edit</button>
                </div>
                <p style="color: #666; font-size: 13px; margin-bottom: 16px;">
                    These costs apply to ALL transactions in addition to brokerage. Includes STT, stamp duty, GST, exchange charges, etc.
                </p>
                
                <!-- Display Mode -->
                <div id="other-costs-display" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px;">
                    <div style="border: 1px solid #e5e7eb; padding: 10px; border-radius: 6px; background: #f9fafb;">
                        <h4 style="margin: 0 0 8px 0; font-size: 12px; font-weight: 600; color: #374151;">EQ Delivery</h4>
                        <div style="font-size: 18px; font-weight: 600; color: #2563eb;" id="display-eq-delivery">0.00%</div>
                    </div>

                    <div style="border: 1px solid #e5e7eb; padding: 10px; border-radius: 6px; background: #f9fafb;">
                        <h4 style="margin: 0 0 8px 0; font-size: 12px; font-weight: 600; color: #374151;">EQ Intraday</h4>
                        <div style="font-size: 18px; font-weight: 600; color: #2563eb;" id="display-eq-intraday">0.00%</div>
                    </div>

                    <div style="border: 1px solid #e5e7eb; padding: 10px; border-radius: 6px; background: #f9fafb;">
                        <h4 style="margin: 0 0 8px 0; font-size: 12px; font-weight: 600; color: #374151;">Futures</h4>
                        <div style="font-size: 18px; font-weight: 600; color: #2563eb;" id="display-futures">0.00%</div>
                    </div>

                    <div style="border: 1px solid #e5e7eb; padding: 10px; border-radius: 6px; background: #f9fafb;">
                        <h4 style="margin: 0 0 8px 0; font-size: 12px; font-weight: 600; color: #374151;">Options</h4>
                        <div style="font-size: 18px; font-weight: 600; color: #2563eb;" id="display-options">0.00%</div>
                        <div style="font-size: 10px; color: #666; margin-top: 4px;">% of Premium</div>
                    </div>
                </div>

                <!-- Edit Mode -->
                <div id="other-costs-edit" style="display: none;">
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px;">
                        <!-- EQ Delivery -->
                        <div style="border: 1px solid #e5e7eb; padding: 10px; border-radius: 6px;">
                            <h4 style="margin: 0 0 8px 0; font-size: 12px; font-weight: 600; color: #374151;">EQ Delivery</h4>
                            <div class="form-group" style="margin: 0;">
                                <label style="font-size: 11px;">% of Value</label>
                                <input type="number" id="other-eq-delivery-pct" step="0.01" min="0" placeholder="0.1" value="0" style="padding: 6px; font-size: 13px;">
                            </div>
                        </div>

                        <!-- EQ Intraday -->
                        <div style="border: 1px solid #e5e7eb; padding: 10px; border-radius: 6px;">
                            <h4 style="margin: 0 0 8px 0; font-size: 12px; font-weight: 600; color: #374151;">EQ Intraday</h4>
                            <div class="form-group" style="margin: 0;">
                                <label style="font-size: 11px;">% of Value</label>
                                <input type="number" id="other-eq-intraday-pct" step="0.01" min="0" placeholder="0.05" value="0" style="padding: 6px; font-size: 13px;">
                            </div>
                        </div>

                        <!-- Futures -->
                        <div style="border: 1px solid #e5e7eb; padding: 10px; border-radius: 6px;">
                            <h4 style="margin: 0 0 8px 0; font-size: 12px; font-weight: 600; color: #374151;">Futures</h4>
                            <div class="form-group" style="margin: 0;">
                                <label style="font-size: 11px;">% of Value</label>
                                <input type="number" id="other-futures-pct" step="0.01" min="0" placeholder="0.05" value="0" style="padding: 6px; font-size: 13px;">
                            </div>
                        </div>

                        <!-- Options -->
                        <div style="border: 1px solid #e5e7eb; padding: 10px; border-radius: 6px;">
                            <h4 style="margin: 0 0 8px 0; font-size: 12px; font-weight: 600; color: #374151;">Options</h4>
                            <div class="form-group" style="margin: 0;">
                                <label style="font-size: 11px;">% of Premium</label>
                                <input type="number" id="other-options-pct" step="0.01" min="0" placeholder="0.05" value="0" style="padding: 6px; font-size: 13px;">
                            </div>
                        </div>
                    </div>

                    <div style="margin-top: 16px; display: flex; gap: 10px;">
                        <button class="btn btn-primary" onclick="saveOtherCosts()">Save Other Costs</button>
                        <button class="btn" onclick="cancelEditOtherCosts()" style="background: #6b7280; color: white;">Cancel</button>
                    </div>
                </div>

                <div id="other-costs-status" style="margin-top: 12px;"></div>
            </div>
        </div>

        <!-- Transactions Tab -->
        <div id="transactions-tab" class="tab-content">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <h2 style="margin: 0;">Add Transaction</h2>
                    <div>
                        <input type="file" id="excel-import-file" accept=".csv" style="display: none;" onchange="importCSV(event)">
                        <button class="btn btn-primary" onclick="document.getElementById('excel-import-file').click()">üìä Import CSV</button>
                    </div>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Investor > Broker *</label>
                        <select id="txn-investor-broker">
                            <option value="">Select investor & broker...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Stock Symbol *</label>
                        <input type="text" id="txn-symbol" placeholder="RELIANCE, TCS, NIFTY" style="text-transform: uppercase;">
                    </div>
                    <div class="form-group">
                        <label>Category *</label>
                        <select id="txn-category" onchange="handleCategoryChange()">
                            <option value="">Select category...</option>
                            <option value="eq-delivery">Equity Delivery</option>
                            <option value="eq-intraday">Equity Intraday</option>
                            <option value="futures">Futures</option>
                            <option value="options">Options</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Quantity (+ve buy, -ve sell) *</label>
                        <input type="number" id="txn-quantity" placeholder="100 or -50">
                    </div>
                    <div class="form-group">
                        <label>Price per Share/Premium (‚Çπ) *</label>
                        <input type="number" step="0.01" id="txn-price" placeholder="1500.00">
                    </div>
                    <div class="form-group">
                        <label>Date *</label>
                        <input type="date" id="txn-date">
                    </div>
                    <div class="form-group">
                        <label>Costs (Brokerage + Others) (‚Çπ)</label>
                        <div style="display: flex; gap: 8px;">
                            <input type="number" step="0.01" id="txn-costs" placeholder="20.00" value="0" style="flex: 1;">
                            <button type="button" onclick="autoCalculateCosts()" class="btn" style="background: #10b981; color: white; padding: 8px 12px; white-space: nowrap;">üßÆ Auto</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Tags</label>
                        <div class="filter-search-container">
                            <input type="text" 
                                   id="txn-tags-input" 
                                   class="filter-search-input" 
                                   placeholder="Type to add tags..."
                                   onfocus="showTxnTagSuggestions()"
                                   oninput="filterTxnTagSuggestions()"
                                   onkeydown="handleTxnTagKeydown(event)">
                            <div id="txn-tag-suggestions" class="search-results"></div>
                        </div>
                        <div id="txn-selected-tags" class="filter-selected-tags"></div>
                    </div>
                </div>
                <button class="btn btn-success" onclick="addTransaction()">Add Transaction</button>
            </div>

            <div class="card">
                <h2>Transaction History</h2>
                <div style="overflow-x: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Investor</th>
                                <th>Type</th>
                                <th>Symbol</th>
                                <th class="text-right">Qty</th>
                                <th class="text-right">Price (‚Çπ)</th>
                                <th class="text-right">Total (‚Çπ)</th>
                                <th>Tags</th>
                            </tr>
                        </thead>
                        <tbody id="transactions-list"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Portfolio Tab -->
        <div id="portfolio-tab" class="tab-content">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin: 0;">Portfolio Holdings</h2>
                </div>
                <p style="color: #666; font-size: 14px; margin-bottom: 16px;">Note: Current prices shown are based on your last transaction price for each stock.</p>

                <div class="form-grid" style="margin-bottom: 20px;">
                    <div class="form-group">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <label style="margin: 0; font-weight: 600;">Filter by Investor</label>
                            <span style="font-size: 12px; color: #2563eb; cursor: pointer; font-weight: normal;" onclick="clearInvestorFilters()" id="clear-investors">Clear all</span>
                        </div>
                        <div class="filter-search-container">
                            <input type="text" 
                                   class="filter-search-input" 
                                   id="investor-search-input" 
                                   placeholder="Type to search investors..."
                                   oninput="filterInvestorSearch()"
                                   onclick="showInvestorDropdown()">
                            <div class="filter-dropdown" id="investor-dropdown"></div>
                        </div>
                        <div class="filter-selected-tags" id="selected-investors"></div>
                    </div>
                    <div class="form-group">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <label style="margin: 0; font-weight: 600;">Filter by Tag</label>
                            <div style="display: flex; align-items: center; gap: 16px;">
                                <div style="display: flex; gap: 12px; align-items: center; font-size: 12px; color: #666;">
                                    <span>Match:</span>
                                    <label style="margin: 0; display: inline-flex; align-items: center; gap: 4px; cursor: pointer; font-weight: normal;">
                                        <input type="radio" name="tag-logic" value="OR" checked onchange="updateTagLogic()" style="margin: 0;">
                                        <span>Any</span>
                                    </label>
                                    <label style="margin: 0; display: inline-flex; align-items: center; gap: 4px; cursor: pointer; font-weight: normal;">
                                        <input type="radio" name="tag-logic" value="AND" onchange="updateTagLogic()" style="margin: 0;">
                                        <span>All</span>
                                    </label>
                                </div>
                                <span style="font-size: 12px; color: #2563eb; cursor: pointer; font-weight: normal;" onclick="clearTagFilters()" id="clear-tags">Clear all</span>
                            </div>
                        </div>
                        <div class="filter-search-container">
                            <input type="text" 
                                   class="filter-search-input" 
                                   id="tag-search-input" 
                                   placeholder="Type to search tags..."
                                   oninput="filterTagSearch()"
                                   onclick="showTagDropdown()">
                            <div class="filter-dropdown" id="tag-dropdown"></div>
                        </div>
                        <div class="filter-selected-tags" id="selected-tags"></div>
                    </div>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th onclick="sortPortfolio('symbol')">Symbol <span class="sort-indicator" id="sort-symbol"></span></th>
                                <th class="text-right">Qty<br><span style="font-size: 10px; font-weight: normal;">Avg Cost (‚Çπ)</span></th>
                                <th class="text-right" onclick="sortPortfolio('invested')">Invested Value (‚Çπ)<br><span style="font-size: 10px; font-weight: normal;">% of Total</span> <span class="sort-indicator" id="sort-invested"></span></th>
                                <th class="text-right">Current Price (‚Çπ)</th>
                                <th class="text-right" onclick="sortPortfolio('pl')">P&L (‚Çπ)<br><span style="font-size: 10px; font-weight: normal;">P&L %</span> <span class="sort-indicator" id="sort-pl"></span></th>
                                <th class="text-right" onclick="sortPortfolio('value')">Value (‚Çπ)<br><span style="font-size: 10px; font-weight: normal;">% of Total</span> <span class="sort-indicator" id="sort-value"></span></th>
                                <th>Tags</th>
                            </tr>
                        </thead>
                        <tbody id="portfolio-list"></tbody>
                    </table>
                </div>

                <div class="summary-cards" id="portfolio-summary"></div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="delete-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; align-items: center; justify-content: center;">
        <div style="background: white; padding: 30px; border-radius: 12px; max-width: 500px; margin: 20px;">
            <h2 style="color: #ef4444; margin-top: 0;">‚ö†Ô∏è Delete All Data?</h2>
            <p style="margin: 20px 0;">This will permanently delete:</p>
            <ul style="color: #666; margin: 10px 0 20px 20px;">
                <li>All investors</li>
                <li>All transactions</li>
                <li>All portfolio data</li>
            </ul>
            <p style="color: #ef4444; font-weight: 600;">This action CANNOT be undone!</p>
            <div style="display: flex; gap: 10px; margin-top: 30px; justify-content: flex-end;">
                <button class="btn" onclick="closeDeleteModal()" style="background: #6b7280; color: white;">Cancel</button>
                <button class="btn" onclick="confirmDelete()" style="background: #ef4444; color: white;">Delete Everything</button>
            </div>
        </div>
    </div>

    <script>
        // ====================================
        // SUPABASE CONFIGURATION
        // ====================================
        const SUPABASE_URL = 'https://lynvrwteylgpwlwbslse.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx5bnZyd3RleWxncHdsd2JzbHNlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAwOTI4NDMsImV4cCI6MjA4NTY2ODg0M30.zHMouEjak_Fpd9LBqHbSOifVfSCZ0U8AqrX94C9oKXc';
        
        // Initialize Supabase client
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // Connection status
        let supabaseConnected = false;
        
        // Test Supabase connection
        async function testSupabaseConnection() {
            try {
                const { data, error } = await supabase.from('brokers').select('count');
                if (error) throw error;
                supabaseConnected = true;
                console.log('‚úÖ Supabase connected successfully!');
                return true;
            } catch (error) {
                supabaseConnected = false;
                console.error('‚ùå Supabase connection failed:', error);
                return false;
            }
        }
        
        // Show connection status
        function showConnectionStatus() {
            testSupabaseConnection().then(connected => {
                if (connected) {
                    alert('‚úÖ Supabase Connected!\n\nDatabase: PostgreSQL\nStatus: Online\nMode: Phase 1 - Testing\n\n(localStorage still active)');
                } else {
                    alert('‚ùå Supabase Connection Failed!\n\nPlease check:\n1. Internet connection\n2. Supabase project is running\n3. API keys are correct\n\n(App still works with localStorage)');
                }
            });
        }
        
        // ====================================
        // DATA (localStorage - Phase 1)
        // ====================================
        let investors = JSON.parse(localStorage.getItem('investors') || '[]');
        let brokers = JSON.parse(localStorage.getItem('brokers') || '[]');
        let otherCosts = JSON.parse(localStorage.getItem('otherCosts') || JSON.stringify({
            eqDelivery: { pct: 0 },
            eqIntraday: { pct: 0 },
            futures: { pct: 0 },
            options: { pct: 0 }
        }));
        let transactions = JSON.parse(localStorage.getItem('transactions') || '[]');
        let prices = JSON.parse(localStorage.getItem('prices') || '{}');

        // ====================================
        // INITIALIZE
        // ====================================
        document.getElementById('txn-date').value = new Date().toISOString().split('T')[0];
        
        // Test Supabase connection on load
        testSupabaseConnection().then(connected => {
            console.log(connected ? '‚úÖ Supabase ready' : '‚ö†Ô∏è Using localStorage only');
        });
        
        renderInvestors();
        renderBrokers();
        loadOtherCosts();
        renderTransactions();
        updateDropdowns();

        // ====================================
        // TABS
        // ====================================
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            
            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.classList.add('active');

            if (tabName === 'portfolio') renderPortfolio();
        }

        // Investors
        function addInvestor() {
            const name = document.getElementById('investor-name').value.trim();
            const pan = document.getElementById('investor-pan').value.trim().toUpperCase();

            if (!name || !pan) {
                alert('Please enter both name and PAN');
                return;
            }

            // PAN validation - must be unique
            if (investors.find(inv => inv.pan === pan)) {
                alert('Investor with this PAN already exists. PAN must be unique.');
                return;
            }

            investors.push({
                id: Date.now().toString(),
                name,
                pan,
                brokers: [], // Array of broker relationships
                createdAt: new Date().toISOString()
            });

            localStorage.setItem('investors', JSON.stringify(investors));
            
            // Clear form
            document.getElementById('investor-name').value = '';
            document.getElementById('investor-pan').value = '';
            
            renderInvestors();
            updateDropdowns();
            alert('‚úì Investor added successfully! Now add broker(s) for this investor.');
        }

        function editInvestor(investorId) {
            const investor = investors.find(inv => inv.id === investorId);
            if (!investor) return;

            // Populate form
            document.getElementById('investor-name').value = investor.name;
            document.getElementById('investor-pan').value = investor.pan;

            // Store editing ID
            window.editingInvestorId = investorId;

            // Change form title and button
            document.getElementById('investor-form-title').textContent = 'Edit Investor';
            const addButton = document.querySelector('button[onclick="addInvestor()"]');
            addButton.textContent = 'Update Investor';
            addButton.onclick = function() { updateInvestor(); };

            // Scroll to form
            document.querySelector('#investors-tab .card').scrollIntoView({ behavior: 'smooth' });
        }

        function updateInvestor() {
            const investorId = window.editingInvestorId;
            const investor = investors.find(inv => inv.id === investorId);
            if (!investor) return;

            const name = document.getElementById('investor-name').value.trim();
            const pan = document.getElementById('investor-pan').value.trim().toUpperCase();

            if (!name || !pan) {
                alert('Please enter both name and PAN');
                return;
            }

            // PAN validation - must be unique (excluding current investor)
            if (investors.find(inv => inv.id !== investorId && inv.pan === pan)) {
                alert('Another investor with this PAN already exists. PAN must be unique.');
                return;
            }

            // Update investor
            investor.name = name;
            investor.pan = pan;

            localStorage.setItem('investors', JSON.stringify(investors));

            // Clear form and reset
            document.getElementById('investor-name').value = '';
            document.getElementById('investor-pan').value = '';

            document.getElementById('investor-form-title').textContent = 'Add New Investor';
            const updateButton = document.querySelector('button[onclick="updateInvestor()"]');
            updateButton.textContent = 'Add Investor';
            updateButton.onclick = function() { addInvestor(); };

            delete window.editingInvestorId;

            renderInvestors();
            updateDropdowns();
            alert('‚úì Investor updated successfully!');
        }

        function openAddBrokerModal(investorId) {
            const investor = investors.find(inv => inv.id === investorId);
            if (!investor) return;

            window.currentInvestorId = investorId;
            window.editingBrokerIndex = null;

            document.getElementById('broker-modal-title').textContent = `Add Broker for ${investor.name}`;
            document.getElementById('modal-broker-select').value = '';
            document.getElementById('modal-brokerage-section').style.display = 'none';
            
            // Populate broker dropdown
            const brokerSelect = document.getElementById('modal-broker-select');
            brokerSelect.innerHTML = '<option value="">Select broker...</option>' + 
                brokers.map(b => `<option value="${b.id}">${b.name}</option>`).join('');

            document.getElementById('investor-broker-modal').style.display = 'block';
        }

        function openEditBrokerModal(investorId, brokerIndex) {
            const investor = investors.find(inv => inv.id === investorId);
            if (!investor || !investor.brokers[brokerIndex]) return;

            const brokerRelation = investor.brokers[brokerIndex];
            const broker = brokers.find(b => b.id === brokerRelation.brokerId);

            window.currentInvestorId = investorId;
            window.editingBrokerIndex = brokerIndex;

            document.getElementById('broker-modal-title').textContent = `Edit Broker - ${broker.name}`;
            document.getElementById('modal-broker-select').value = brokerRelation.brokerId;
            
            // Show and populate brokerage
            document.getElementById('modal-brokerage-section').style.display = 'block';
            document.getElementById('modal-eq-delivery-pct').value = brokerRelation.brokerage.eqDelivery.pct;
            document.getElementById('modal-eq-delivery-max').value = brokerRelation.brokerage.eqDelivery.max;
            document.getElementById('modal-eq-intraday-pct').value = brokerRelation.brokerage.eqIntraday.pct;
            document.getElementById('modal-eq-intraday-max').value = brokerRelation.brokerage.eqIntraday.max;
            document.getElementById('modal-futures-pct').value = brokerRelation.brokerage.futures.pct;
            document.getElementById('modal-futures-max').value = brokerRelation.brokerage.futures.max;
            document.getElementById('modal-options-flat').value = brokerRelation.brokerage.options.flat;
            document.getElementById('modal-options-max').value = brokerRelation.brokerage.options.max;

            // Populate broker dropdown
            const brokerSelect = document.getElementById('modal-broker-select');
            brokerSelect.innerHTML = '<option value="">Select broker...</option>' + 
                brokers.map(b => `<option value="${b.id}">${b.name}</option>`).join('');
            brokerSelect.value = brokerRelation.brokerId;

            document.getElementById('investor-broker-modal').style.display = 'block';
        }

        function closeBrokerModal() {
            document.getElementById('investor-broker-modal').style.display = 'none';
            window.currentInvestorId = null;
            window.editingBrokerIndex = null;
        }

        function loadModalBrokerBrokerage() {
            const brokerId = document.getElementById('modal-broker-select').value;
            const section = document.getElementById('modal-brokerage-section');
            
            if (!brokerId) {
                section.style.display = 'none';
                return;
            }

            const broker = brokers.find(b => b.id === brokerId);
            if (!broker) return;

            section.style.display = 'block';
            
            // Only load defaults if adding new (not editing)
            if (window.editingBrokerIndex === null) {
                document.getElementById('modal-eq-delivery-pct').value = broker.brokerage.eqDelivery.pct;
                document.getElementById('modal-eq-delivery-max').value = broker.brokerage.eqDelivery.max;
                document.getElementById('modal-eq-intraday-pct').value = broker.brokerage.eqIntraday.pct;
                document.getElementById('modal-eq-intraday-max').value = broker.brokerage.eqIntraday.max;
                document.getElementById('modal-futures-pct').value = broker.brokerage.futures.pct;
                document.getElementById('modal-futures-max').value = broker.brokerage.futures.max;
                document.getElementById('modal-options-flat').value = broker.brokerage.options.flat;
                document.getElementById('modal-options-max').value = broker.brokerage.options.max;
            }
        }

        function saveBrokerForInvestor() {
            const investorId = window.currentInvestorId;
            const investor = investors.find(inv => inv.id === investorId);
            if (!investor) return;

            const brokerId = document.getElementById('modal-broker-select').value;
            if (!brokerId) {
                alert('Please select a broker');
                return;
            }

            // Check if broker already exists for this investor (when adding new)
            if (window.editingBrokerIndex === null && 
                investor.brokers.some(b => b.brokerId === brokerId)) {
                alert('This broker is already added for this investor');
                return;
            }

            const brokerage = {
                eqDelivery: {
                    pct: parseFloat(document.getElementById('modal-eq-delivery-pct').value) || 0,
                    max: parseFloat(document.getElementById('modal-eq-delivery-max').value) || 0
                },
                eqIntraday: {
                    pct: parseFloat(document.getElementById('modal-eq-intraday-pct').value) || 0,
                    max: parseFloat(document.getElementById('modal-eq-intraday-max').value) || 0
                },
                futures: {
                    pct: parseFloat(document.getElementById('modal-futures-pct').value) || 0,
                    max: parseFloat(document.getElementById('modal-futures-max').value) || 0
                },
                options: {
                    flat: parseFloat(document.getElementById('modal-options-flat').value) || 0,
                    max: parseFloat(document.getElementById('modal-options-max').value) || 0
                }
            };

            if (window.editingBrokerIndex !== null) {
                // Update existing broker
                investor.brokers[window.editingBrokerIndex] = {
                    brokerId,
                    brokerage
                };
            } else {
                // Add new broker
                if (!investor.brokers) investor.brokers = [];
                investor.brokers.push({
                    brokerId,
                    brokerage
                });
            }

            localStorage.setItem('investors', JSON.stringify(investors));
            
            closeBrokerModal();
            renderInvestors();
            updateDropdowns();
            alert('‚úì Broker saved successfully!');
        }

        function deleteBrokerFromInvestor(investorId, brokerIndex) {
            if (!confirm('Remove this broker from the investor?')) return;

            const investor = investors.find(inv => inv.id === investorId);
            if (!investor) return;

            investor.brokers.splice(brokerIndex, 1);
            localStorage.setItem('investors', JSON.stringify(investors));
            
            renderInvestors();
            updateDropdowns();
            alert('‚úì Broker removed successfully!');
        }

        function renderInvestors() {
            const list = document.getElementById('investors-list');
            
            if (investors.length === 0) {
                list.innerHTML = '<div class="empty-state">No investors yet. Add your first investor above.</div>';
                return;
            }

            list.innerHTML = investors.map(inv => {
                // Ensure brokers array exists
                if (!inv.brokers) inv.brokers = [];
                
                // Display brokers
                const brokersHtml = (inv.brokers.length > 0) ? `
                    <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #e5e7eb;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <div style="font-size: 12px; color: #666; font-weight: 600;">Brokers (${inv.brokers.length}):</div>
                            <button onclick="openAddBrokerModal('${inv.id}')" style="padding: 3px 10px; background: #10b981; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;">+ Add Broker</button>
                        </div>
                        ${inv.brokers.map((brokerRel, index) => {
                            const broker = brokers.find(b => b.id === brokerRel.brokerId);
                            if (!brokerRel.brokerage) {
                                brokerRel.brokerage = {
                                    eqDelivery: { pct: 0, max: 0 },
                                    eqIntraday: { pct: 0, max: 0 },
                                    futures: { pct: 0, max: 0 },
                                    options: { flat: 0, max: 0 }
                                };
                            }
                            return `
                            <div style="background: #f9fafb; padding: 10px; border-radius: 6px; margin-bottom: 8px; border: 1px solid #e5e7eb;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                                    <div style="font-weight: 600; font-size: 13px; flex: 1;">${broker ? broker.name : 'Unknown Broker'}</div>
                                    <div style="display: flex; gap: 6px;">
                                        <button onclick="openEditBrokerModal('${inv.id}', ${index})" style="padding: 2px 8px; background: #f59e0b; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 10px;">Edit</button>
                                        <button onclick="deleteBrokerFromInvestor('${inv.id}', ${index})" style="padding: 2px 8px; background: #ef4444; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 10px;">Remove</button>
                                    </div>
                                </div>
                                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; font-size: 10px;">
                                    <div style="background: white; padding: 5px; border-radius: 3px;">
                                        <div style="font-weight: 600; color: #374151; margin-bottom: 2px;">EQ Del</div>
                                        <div style="color: #666;">${brokerRel.brokerage.eqDelivery.pct}%${brokerRel.brokerage.eqDelivery.max > 0 ? ` (max ‚Çπ${brokerRel.brokerage.eqDelivery.max})` : ''}</div>
                                    </div>
                                    <div style="background: white; padding: 5px; border-radius: 3px;">
                                        <div style="font-weight: 600; color: #374151; margin-bottom: 2px;">EQ Intra</div>
                                        <div style="color: #666;">${brokerRel.brokerage.eqIntraday.pct}%${brokerRel.brokerage.eqIntraday.max > 0 ? ` (max ‚Çπ${brokerRel.brokerage.eqIntraday.max})` : ''}</div>
                                    </div>
                                    <div style="background: white; padding: 5px; border-radius: 3px;">
                                        <div style="font-weight: 600; color: #374151; margin-bottom: 2px;">Futures</div>
                                        <div style="color: #666;">${brokerRel.brokerage.futures.pct}%${brokerRel.brokerage.futures.max > 0 ? ` (max ‚Çπ${brokerRel.brokerage.futures.max})` : ''}</div>
                                    </div>
                                    <div style="background: white; padding: 5px; border-radius: 3px;">
                                        <div style="font-weight: 600; color: #374151; margin-bottom: 2px;">Options</div>
                                        <div style="color: #666;">‚Çπ${brokerRel.brokerage.options.flat}/lot${brokerRel.brokerage.options.max > 0 ? ` (max ‚Çπ${brokerRel.brokerage.options.max})` : ''}</div>
                                    </div>
                                </div>
                            </div>
                            `}).join('')}
                    </div>
                ` : `
                    <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #e5e7eb;">
                        <button onclick="openAddBrokerModal('${inv.id}')" style="padding: 6px 12px; background: #10b981; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; width: 100%;">+ Add First Broker</button>
                    </div>
                `;

                return `
                <div style="padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 12px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <div>
                            <div style="font-weight: 600; font-size: 15px;">${inv.name}</div>
                            <div style="color: #666; font-size: 13px; margin-top: 2px;">PAN: ${inv.pan}</div>
                        </div>
                        <button onclick="editInvestor('${inv.id}')" style="padding: 4px 12px; background: #f59e0b; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">‚úèÔ∏è Edit</button>
                    </div>
                    ${brokersHtml}
                </div>
            `}).join('');
        }

        // Brokers
        function addBroker() {
            const name = document.getElementById('broker-name').value.trim();
            
            // EQ Delivery
            const eqDeliveryPct = parseFloat(document.getElementById('broker-eq-delivery-pct').value) || 0;
            const eqDeliveryMax = parseFloat(document.getElementById('broker-eq-delivery-max').value) || 0;
            
            // EQ Intraday
            const eqIntradayPct = parseFloat(document.getElementById('broker-eq-intraday-pct').value) || 0;
            const eqIntradayMax = parseFloat(document.getElementById('broker-eq-intraday-max').value) || 0;
            
            // Futures
            const futuresPct = parseFloat(document.getElementById('broker-futures-pct').value) || 0;
            const futuresMax = parseFloat(document.getElementById('broker-futures-max').value) || 0;
            
            // Options
            const optionsFlat = parseFloat(document.getElementById('broker-options-flat').value) || 0;
            const optionsMax = parseFloat(document.getElementById('broker-options-max').value) || 0;

            if (!name) {
                alert('Please enter broker name');
                return;
            }

            if (brokers.find(b => b.name.toLowerCase() === name.toLowerCase())) {
                alert('Broker with this name already exists');
                return;
            }

            const broker = {
                id: Date.now().toString(),
                name,
                brokerage: {
                    eqDelivery: { pct: eqDeliveryPct, max: eqDeliveryMax },
                    eqIntraday: { pct: eqIntradayPct, max: eqIntradayMax },
                    futures: { pct: futuresPct, max: futuresMax },
                    options: { flat: optionsFlat, max: optionsMax }
                },
                createdAt: new Date().toISOString()
            };

            brokers.push(broker);
            localStorage.setItem('brokers', JSON.stringify(brokers));
            
            // Clear form
            document.getElementById('broker-name').value = '';
            document.getElementById('broker-eq-delivery-pct').value = '0';
            document.getElementById('broker-eq-delivery-max').value = '0';
            document.getElementById('broker-eq-intraday-pct').value = '0';
            document.getElementById('broker-eq-intraday-max').value = '0';
            document.getElementById('broker-futures-pct').value = '0';
            document.getElementById('broker-futures-max').value = '0';
            document.getElementById('broker-options-flat').value = '0';
            document.getElementById('broker-options-max').value = '0';
            
            renderBrokers();
            updateDropdowns();
            alert('‚úì Broker added successfully!');
        }

        function renderBrokers() {
            const list = document.getElementById('brokers-list');
            
            if (brokers.length === 0) {
                list.innerHTML = '<div class="empty-state">No brokers yet. Add your first broker above.</div>';
                return;
            }

            list.innerHTML = brokers.map(broker => `
                <div style="padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 12px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <div style="font-weight: 600; font-size: 15px;">${broker.name}</div>
                        <button onclick="editBroker('${broker.id}')" style="padding: 4px 12px; background: #f59e0b; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">‚úèÔ∏è Edit</button>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; font-size: 12px;">
                        <div style="background: #f9fafb; padding: 8px; border-radius: 4px;">
                            <div style="font-weight: 600; color: #374151; margin-bottom: 3px; font-size: 11px;">EQ Delivery</div>
                            <div style="color: #666;">${broker.brokerage.eqDelivery.pct}%${broker.brokerage.eqDelivery.max > 0 ? ` (max ‚Çπ${broker.brokerage.eqDelivery.max})` : ''}</div>
                        </div>
                        
                        <div style="background: #f9fafb; padding: 8px; border-radius: 4px;">
                            <div style="font-weight: 600; color: #374151; margin-bottom: 3px; font-size: 11px;">EQ Intraday</div>
                            <div style="color: #666;">${broker.brokerage.eqIntraday.pct}%${broker.brokerage.eqIntraday.max > 0 ? ` (max ‚Çπ${broker.brokerage.eqIntraday.max})` : ''}</div>
                        </div>
                        
                        <div style="background: #f9fafb; padding: 8px; border-radius: 4px;">
                            <div style="font-weight: 600; color: #374151; margin-bottom: 3px; font-size: 11px;">Futures</div>
                            <div style="color: #666;">${broker.brokerage.futures.pct}%${broker.brokerage.futures.max > 0 ? ` (max ‚Çπ${broker.brokerage.futures.max})` : ''}</div>
                        </div>
                        
                        <div style="background: #f9fafb; padding: 8px; border-radius: 4px;">
                            <div style="font-weight: 600; color: #374151; margin-bottom: 3px; font-size: 11px;">Options</div>
                            <div style="color: #666;">‚Çπ${broker.brokerage.options.flat}/lot${broker.brokerage.options.max > 0 ? ` (max ‚Çπ${broker.brokerage.options.max})` : ''}</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function editBroker(brokerId) {
            const broker = brokers.find(b => b.id === brokerId);
            if (!broker) return;

            // Populate the form with broker's current data
            document.getElementById('broker-name').value = broker.name;
            document.getElementById('broker-eq-delivery-pct').value = broker.brokerage.eqDelivery.pct;
            document.getElementById('broker-eq-delivery-max').value = broker.brokerage.eqDelivery.max;
            document.getElementById('broker-eq-intraday-pct').value = broker.brokerage.eqIntraday.pct;
            document.getElementById('broker-eq-intraday-max').value = broker.brokerage.eqIntraday.max;
            document.getElementById('broker-futures-pct').value = broker.brokerage.futures.pct;
            document.getElementById('broker-futures-max').value = broker.brokerage.futures.max;
            document.getElementById('broker-options-flat').value = broker.brokerage.options.flat;
            document.getElementById('broker-options-max').value = broker.brokerage.options.max;

            // Store the ID being edited
            window.editingBrokerId = brokerId;

            // Change button text
            const addButton = document.querySelector('button[onclick="addBroker()"]');
            addButton.textContent = 'Update Broker';
            addButton.onclick = function() { updateBroker(); };

            // Scroll to form
            document.querySelector('#brokers-tab .card').scrollIntoView({ behavior: 'smooth' });
        }

        function updateBroker() {
            const brokerId = window.editingBrokerId;
            const broker = brokers.find(b => b.id === brokerId);
            if (!broker) return;

            const name = document.getElementById('broker-name').value.trim();
            
            // Get updated values
            const eqDeliveryPct = parseFloat(document.getElementById('broker-eq-delivery-pct').value) || 0;
            const eqDeliveryMax = parseFloat(document.getElementById('broker-eq-delivery-max').value) || 0;
            const eqIntradayPct = parseFloat(document.getElementById('broker-eq-intraday-pct').value) || 0;
            const eqIntradayMax = parseFloat(document.getElementById('broker-eq-intraday-max').value) || 0;
            const futuresPct = parseFloat(document.getElementById('broker-futures-pct').value) || 0;
            const futuresMax = parseFloat(document.getElementById('broker-futures-max').value) || 0;
            const optionsFlat = parseFloat(document.getElementById('broker-options-flat').value) || 0;
            const optionsMax = parseFloat(document.getElementById('broker-options-max').value) || 0;

            if (!name) {
                alert('Please enter broker name');
                return;
            }

            // Check for duplicate name (excluding current broker)
            if (brokers.find(b => b.id !== brokerId && b.name.toLowerCase() === name.toLowerCase())) {
                alert('Broker with this name already exists');
                return;
            }

            // Update broker
            broker.name = name;
            broker.brokerage = {
                eqDelivery: { pct: eqDeliveryPct, max: eqDeliveryMax },
                eqIntraday: { pct: eqIntradayPct, max: eqIntradayMax },
                futures: { pct: futuresPct, max: futuresMax },
                options: { flat: optionsFlat, max: optionsMax }
            };

            localStorage.setItem('brokers', JSON.stringify(brokers));

            // Clear form and reset button
            document.getElementById('broker-name').value = '';
            document.getElementById('broker-eq-delivery-pct').value = '0';
            document.getElementById('broker-eq-delivery-max').value = '0';
            document.getElementById('broker-eq-intraday-pct').value = '0';
            document.getElementById('broker-eq-intraday-max').value = '0';
            document.getElementById('broker-futures-pct').value = '0';
            document.getElementById('broker-futures-max').value = '0';
            document.getElementById('broker-options-flat').value = '0';
            document.getElementById('broker-options-max').value = '0';

            const addButton = document.querySelector('button[onclick="updateBroker()"]');
            addButton.textContent = 'Add Broker';
            addButton.onclick = function() { addBroker(); };

            delete window.editingBrokerId;

            renderBrokers();
            updateDropdowns();
            alert('‚úì Broker updated successfully!');
        }

        // Other Costs
        function editOtherCosts() {
            document.getElementById('other-costs-display').style.display = 'none';
            document.getElementById('other-costs-edit').style.display = 'block';
            document.getElementById('edit-other-costs-btn').style.display = 'none';
        }

        function cancelEditOtherCosts() {
            document.getElementById('other-costs-display').style.display = 'grid';
            document.getElementById('other-costs-edit').style.display = 'none';
            document.getElementById('edit-other-costs-btn').style.display = 'block';
            
            // Reload original values
            loadOtherCosts();
        }

        function displayOtherCosts() {
            document.getElementById('display-eq-delivery').textContent = otherCosts.eqDelivery.pct.toFixed(2) + '%';
            document.getElementById('display-eq-intraday').textContent = otherCosts.eqIntraday.pct.toFixed(2) + '%';
            document.getElementById('display-futures').textContent = otherCosts.futures.pct.toFixed(2) + '%';
            document.getElementById('display-options').textContent = otherCosts.options.pct.toFixed(2) + '%';
        }

        function saveOtherCosts() {
            otherCosts = {
                eqDelivery: {
                    pct: parseFloat(document.getElementById('other-eq-delivery-pct').value) || 0
                },
                eqIntraday: {
                    pct: parseFloat(document.getElementById('other-eq-intraday-pct').value) || 0
                },
                futures: {
                    pct: parseFloat(document.getElementById('other-futures-pct').value) || 0
                },
                options: {
                    pct: parseFloat(document.getElementById('other-options-pct').value) || 0
                }
            };

            localStorage.setItem('otherCosts', JSON.stringify(otherCosts));
            
            // Update display
            displayOtherCosts();
            
            // Switch back to display mode
            document.getElementById('other-costs-display').style.display = 'grid';
            document.getElementById('other-costs-edit').style.display = 'none';
            document.getElementById('edit-other-costs-btn').style.display = 'block';
            
            const statusDiv = document.getElementById('other-costs-status');
            statusDiv.innerHTML = '<div style="color: #10b981; font-weight: 600;">‚úì Other costs saved successfully!</div>';
            setTimeout(() => {
                statusDiv.innerHTML = '';
            }, 3000);
        }

        function loadOtherCosts() {
            document.getElementById('other-eq-delivery-pct').value = otherCosts.eqDelivery.pct;
            document.getElementById('other-eq-intraday-pct').value = otherCosts.eqIntraday.pct;
            document.getElementById('other-futures-pct').value = otherCosts.futures.pct;
            document.getElementById('other-options-pct').value = otherCosts.options.pct || otherCosts.options.flat || 0; // Handle old data
            
            // Update display
            displayOtherCosts();
        }

        // Transaction Tag Selection
        let tempFODetails = {
            category: null,
            symbol: null,
            futuresExpiry: null,
            optionsExpiry: null,
            optionsType: null,
            optionsStrike: null
        };

        function autoCalculateCosts() {
            // Get transaction details
            const investorBrokerCombo = document.getElementById('txn-investor-broker').value;
            const category = document.getElementById('txn-category').value;
            const quantity = parseFloat(document.getElementById('txn-quantity').value);
            const price = parseFloat(document.getElementById('txn-price').value);

            // Validate inputs
            if (!investorBrokerCombo) {
                alert('Please select Investor > Broker first');
                return;
            }
            if (!category) {
                alert('Please select Category first');
                return;
            }
            if (isNaN(quantity) || quantity === 0) {
                alert('Please enter valid Quantity');
                return;
            }
            if (isNaN(price) || price <= 0) {
                alert('Please enter valid Price');
                return;
            }

            // Parse investor-broker combo
            const [investorId, brokerId] = investorBrokerCombo.split('|');
            const investor = investors.find(inv => inv.id === investorId);
            const broker = brokers.find(b => b.id === brokerId);

            if (!investor || !broker) {
                alert('Invalid investor or broker');
                return;
            }

            // Ensure investor has brokers array
            if (!investor.brokers || !Array.isArray(investor.brokers)) {
                alert('This investor has no brokers assigned. Please add a broker first in the Investors tab.');
                return;
            }

            // Find broker relationship for this investor
            const brokerRelation = investor.brokers.find(b => b.brokerId === brokerId);
            if (!brokerRelation) {
                alert('This broker is not assigned to this investor. Please add it first in the Investors tab.');
                return;
            }
            
            if (!brokerRelation.brokerage) {
                alert('Brokerage rates not found for this investor-broker combination');
                return;
            }

            // Calculate trade value
            const tradeValue = Math.abs(quantity) * price;

            // Get brokerage and other costs rates based on category
            let brokerageRates, otherCostsRates;
            
            switch(category) {
                case 'eq-delivery':
                    brokerageRates = brokerRelation.brokerage.eqDelivery;
                    otherCostsRates = otherCosts.eqDelivery;
                    break;
                case 'eq-intraday':
                    brokerageRates = brokerRelation.brokerage.eqIntraday;
                    otherCostsRates = otherCosts.eqIntraday;
                    break;
                case 'futures':
                    brokerageRates = brokerRelation.brokerage.futures;
                    otherCostsRates = otherCosts.futures;
                    break;
                case 'options':
                    brokerageRates = brokerRelation.brokerage.options;
                    otherCostsRates = otherCosts.options;
                    break;
                default:
                    alert('Invalid category');
                    return;
            }

            // Calculate brokerage with smart 0-handling
            let brokerage = 0;
            
            if (category === 'options') {
                // Options: flat per lot or max (whichever is non-zero, or lower if both non-zero)
                const flatAmount = brokerageRates.flat || 0;
                const maxAmount = brokerageRates.max || 0;
                
                if (flatAmount === 0 && maxAmount > 0) {
                    brokerage = maxAmount; // Use max if flat is 0
                } else if (flatAmount > 0 && maxAmount === 0) {
                    brokerage = flatAmount; // Use flat if max is 0
                } else if (flatAmount > 0 && maxAmount > 0) {
                    brokerage = Math.min(flatAmount, maxAmount); // Both non-zero: take lower
                }
                // If both are 0, brokerage remains 0
            } else {
                // Equity/Futures: percentage or max (whichever is non-zero, or lower if both non-zero)
                const pctAmount = (tradeValue * brokerageRates.pct) / 100;
                const maxAmount = brokerageRates.max || 0;
                
                if (brokerageRates.pct === 0 && maxAmount > 0) {
                    brokerage = maxAmount; // Use max if % is 0
                } else if (brokerageRates.pct > 0 && maxAmount === 0) {
                    brokerage = pctAmount; // Use % if max is 0
                } else if (brokerageRates.pct > 0 && maxAmount > 0) {
                    brokerage = Math.min(pctAmount, maxAmount); // Both non-zero: cap at max
                }
                // If both are 0, brokerage remains 0
            }

            // Calculate other costs with smart 0-handling
            let otherCostsAmount = 0;
            
            if (category === 'options') {
                // Options other costs: percentage of premium
                const premiumValue = tradeValue; // For options, trade value is the premium
                otherCostsAmount = (premiumValue * otherCostsRates.pct) / 100;
            } else {
                // Equity/Futures other costs: percentage of trade value
                otherCostsAmount = (tradeValue * otherCostsRates.pct) / 100;
            }

            // Total costs
            const totalCosts = brokerage + otherCostsAmount;

            // Update the costs field
            document.getElementById('txn-costs').value = totalCosts.toFixed(2);

            // Show breakdown in alert
            alert(`Cost Breakdown:\n\nBrokerage: ‚Çπ${brokerage.toFixed(2)}\nOther Costs: ‚Çπ${otherCostsAmount.toFixed(2)}\n\nTotal: ‚Çπ${totalCosts.toFixed(2)}`);
        }

        function handleCategoryChange() {
            const category = document.getElementById('txn-category').value;
            const symbol = document.getElementById('txn-symbol').value.trim().toUpperCase();
            
            if (category === 'futures' || category === 'options') {
                // Validate symbol is entered first
                if (!symbol) {
                    alert('Please enter Symbol first before selecting Futures/Options');
                    document.getElementById('txn-category').value = '';
                    document.getElementById('txn-symbol').focus();
                    return;
                }
                openFOModal(category, symbol);
            } else {
                // Clear F&O details for equity categories
                tempFODetails = {
                    category: category,
                    symbol: symbol,
                    futuresExpiry: null,
                    optionsExpiry: null,
                    optionsType: null,
                    optionsStrike: null
                };
            }
        }

        function openFOModal(category, symbol) {
            tempFODetails.category = category;
            tempFODetails.symbol = symbol;
            
            const modal = document.getElementById('fo-details-modal');
            const title = document.getElementById('fo-modal-title');
            const futuresSection = document.getElementById('fo-futures-section');
            const optionsSection = document.getElementById('fo-options-section');
            
            if (category === 'futures') {
                title.textContent = 'Futures Details';
                futuresSection.style.display = 'block';
                optionsSection.style.display = 'none';
                
                // Display symbol
                document.getElementById('fo-futures-symbol-display').textContent = symbol;
                
                // Pre-fill if already entered
                if (tempFODetails.futuresExpiry) {
                    document.getElementById('fo-futures-expiry').value = tempFODetails.futuresExpiry;
                } else {
                    document.getElementById('fo-futures-expiry').value = '';
                }
            } else if (category === 'options') {
                title.textContent = 'Options Details';
                futuresSection.style.display = 'none';
                optionsSection.style.display = 'block';
                
                // Display symbol
                document.getElementById('fo-options-symbol-display').textContent = symbol;
                
                // Pre-fill if already entered
                if (tempFODetails.optionsExpiry) {
                    document.getElementById('fo-options-expiry').value = tempFODetails.optionsExpiry;
                    document.getElementById('fo-options-type').value = tempFODetails.optionsType || '';
                    document.getElementById('fo-options-strike').value = tempFODetails.optionsStrike || '';
                } else {
                    document.getElementById('fo-options-expiry').value = '';
                    document.getElementById('fo-options-type').value = '';
                    document.getElementById('fo-options-strike').value = '';
                }
            }
            
            modal.style.display = 'block';
        }

        function closeFOModal() {
            const category = document.getElementById('txn-category').value;
            
            // If user closes modal without saving, reset category to empty
            if (!tempFODetails.futuresExpiry && !tempFODetails.optionsExpiry) {
                document.getElementById('txn-category').value = '';
            }
            
            document.getElementById('fo-details-modal').style.display = 'none';
        }

        function saveFODetails() {
            const category = tempFODetails.category;
            const symbol = tempFODetails.symbol;
            
            if (category === 'futures') {
                const expiry = document.getElementById('fo-futures-expiry').value.trim().toUpperCase();
                
                if (!expiry) {
                    alert('Please enter expiry');
                    return;
                }
                
                tempFODetails.futuresExpiry = expiry;
                
                // Update symbol with concatenated format: NIFTY30JAN26FUT
                const generatedSymbol = `${symbol}${expiry}FUT`;
                document.getElementById('txn-symbol').value = generatedSymbol;
                tempFODetails.symbol = generatedSymbol;
                
            } else if (category === 'options') {
                const expiry = document.getElementById('fo-options-expiry').value.trim().toUpperCase();
                const type = document.getElementById('fo-options-type').value.trim().toUpperCase();
                const strike = parseFloat(document.getElementById('fo-options-strike').value);
                
                if (!expiry || !type || isNaN(strike)) {
                    alert('Please fill all Options fields');
                    return;
                }
                
                if (type !== 'CE' && type !== 'PE') {
                    alert('Type must be CE or PE');
                    return;
                }
                
                tempFODetails.optionsExpiry = expiry;
                tempFODetails.optionsType = type;
                tempFODetails.optionsStrike = strike;
                
                // Update symbol with concatenated format: NIFTY30JAN2618000CE
                const generatedSymbol = `${symbol}${expiry}${strike}${type}`;
                document.getElementById('txn-symbol').value = generatedSymbol;
                tempFODetails.symbol = generatedSymbol;
            }
            
            document.getElementById('fo-details-modal').style.display = 'none';
            
            // Show visual confirmation
            const categorySelect = document.getElementById('txn-category');
            categorySelect.style.background = '#d1fae5';
            setTimeout(() => {
                categorySelect.style.background = '';
            }, 1000);
        }

        function showTxnTagSuggestions() {
            const input = document.getElementById('txn-tags-input').value.trim();
            const suggestions = document.getElementById('txn-tag-suggestions');
            
            // Get all unique tags from existing transactions
            const allTags = new Set();
            transactions.forEach(txn => {
                if (txn.tags && Array.isArray(txn.tags)) {
                    txn.tags.forEach(tag => allTags.add(tag));
                }
            });
            
            const availableTags = Array.from(allTags).filter(tag => !selectedTxnTags.includes(tag));
            
            if (availableTags.length === 0 && !input) {
                suggestions.innerHTML = '<div style="padding: 12px; color: #999; font-size: 13px;">Type and press Enter to add tags</div>';
                suggestions.classList.add('show');
                return;
            }
            
            const filtered = input ? 
                availableTags.filter(tag => tag.toLowerCase().includes(input.toLowerCase())) : 
                availableTags;
            
            if (filtered.length === 0 && input) {
                suggestions.innerHTML = `
                    <div class="search-result-item" onclick="addNewTxnTag('${input}')">
                        <span style="color: #10b981; font-weight: 600;">+ Add "${input}"</span>
                    </div>
                `;
            } else {
                suggestions.innerHTML = filtered.map(tag => `
                    <div class="search-result-item" onclick="toggleTxnTag('${tag}')">
                        <span>${tag}</span>
                    </div>
                `).join('');
                
                if (input && !filtered.find(t => t.toLowerCase() === input.toLowerCase())) {
                    suggestions.innerHTML += `
                        <div class="search-result-item" onclick="addNewTxnTag('${input}')">
                            <span style="color: #10b981; font-weight: 600;">+ Add "${input}"</span>
                        </div>
                    `;
                }
            }
            
            suggestions.classList.add('show');
        }

        function handleTxnTagKeydown(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                const input = document.getElementById('txn-tags-input').value.trim();
                
                if (input) {
                    // Add the tag directly
                    addNewTxnTag(input);
                }
            }
        }

        function filterTxnTagSuggestions() {
            showTxnTagSuggestions();
        }

        function toggleTxnTag(tagName) {
            if (!selectedTxnTags.includes(tagName)) {
                selectedTxnTags.push(tagName);
                renderSelectedTxnTags();
            }
            document.getElementById('txn-tags-input').value = '';
            document.getElementById('txn-tag-suggestions').classList.remove('show');
        }

        function addNewTxnTag(tagName) {
            tagName = tagName.trim();
            if (tagName && !selectedTxnTags.includes(tagName)) {
                selectedTxnTags.push(tagName);
                renderSelectedTxnTags();
            }
            document.getElementById('txn-tags-input').value = '';
            document.getElementById('txn-tag-suggestions').classList.remove('show');
        }

        function removeTxnTag(tagName) {
            selectedTxnTags = selectedTxnTags.filter(tag => tag !== tagName);
            renderSelectedTxnTags();
        }

        function renderSelectedTxnTags() {
            const container = document.getElementById('txn-selected-tags');
            container.innerHTML = selectedTxnTags.map(tag => `
                <div class="filter-tag" onclick="removeTxnTag('${tag}')">
                    ${tag} <span class="tag-remove">√ó</span>
                </div>
            `).join('');
        }

        document.addEventListener('click', function(e) {
            if (!e.target.closest('.filter-search-container')) {
                const suggestions = document.getElementById('txn-tag-suggestions');
                if (suggestions) suggestions.classList.remove('show');
            }
        });

        // Transactions
        function addTransaction() {
            const investorBrokerCombo = document.getElementById('txn-investor-broker').value;
            const category = document.getElementById('txn-category').value;
            const symbol = document.getElementById('txn-symbol').value.trim().toUpperCase();
            const quantity = parseFloat(document.getElementById('txn-quantity').value);
            const price = parseFloat(document.getElementById('txn-price').value);
            const date = document.getElementById('txn-date').value;
            const costs = parseFloat(document.getElementById('txn-costs').value) || 0;

            // Validate basic fields
            if (!investorBrokerCombo || !category || !symbol || isNaN(quantity) || !price || !date) {
                alert('Please fill all required fields');
                return;
            }

            if (quantity === 0) {
                alert('Quantity cannot be zero');
                return;
            }

            // Validate category-specific details from modal
            if (category === 'futures' && !tempFODetails.futuresExpiry) {
                alert('Please enter Futures details (click category again to open)');
                return;
            }
            
            if (category === 'options' && (!tempFODetails.optionsExpiry || !tempFODetails.optionsType || !tempFODetails.optionsStrike)) {
                alert('Please enter Options details (click category again to open)');
                return;
            }

            // Parse investor-broker combo (format: "investorId|brokerId")
            const [investorId, brokerId] = investorBrokerCombo.split('|');
            
            const investor = investors.find(inv => inv.id === investorId);
            const broker = brokers.find(b => b.id === brokerId);
            
            if (!investor || !broker) {
                alert('Invalid investor or broker selected');
                return;
            }
            
            const type = quantity > 0 ? 'buy' : 'sell';
            
            // Auto-detect exchange from symbol (simple logic - can be enhanced)
            const exchange = 'NSE'; // Default to NSE, can be made smarter later
            
            // Format date as dd-mmm-yy
            const dateObj = new Date(date);
            const formattedDate = dateObj.toLocaleDateString('en-GB', { 
                day: '2-digit', 
                month: 'short', 
                year: '2-digit' 
            });
            
            // Calculate total including costs
            // For buy: total = (qty * price) + costs
            // For sell: total = (qty * price) - costs (costs reduce the proceeds)
            const baseValue = Math.abs(quantity) * price;
            const totalWithCosts = type === 'buy' ? baseValue + costs : baseValue - costs;
            
            const transaction = {
                id: Date.now().toString(),
                investorId,
                investorName: investor.name,
                brokerId,
                brokerName: broker.name,
                type,
                category,
                symbol,
                exchange,
                quantity: quantity, // Already signed (positive = buy, negative = sell)
                price,
                total: totalWithCosts, // Total including costs
                costs: costs,
                date: date, // Store original date for sorting
                displayDate: formattedDate, // Display formatted date
                tags: [...selectedTxnTags] // Use selected tags
            };

            // Add category-specific fields from tempFODetails
            if (category === 'futures') {
                transaction.futuresExpiry = tempFODetails.futuresExpiry;
            } else if (category === 'options') {
                transaction.optionsExpiry = tempFODetails.optionsExpiry;
                transaction.optionsType = tempFODetails.optionsType;
                transaction.optionsStrike = tempFODetails.optionsStrike;
            }

            transactions.push(transaction);
            localStorage.setItem('transactions', JSON.stringify(transactions));
            
            // Clear form
            document.getElementById('txn-investor-broker').value = '';
            document.getElementById('txn-category').value = '';
            document.getElementById('txn-symbol').value = '';
            document.getElementById('txn-quantity').value = '';
            document.getElementById('txn-price').value = '';
            document.getElementById('txn-costs').value = '0';
            selectedTxnTags = [];
            renderSelectedTxnTags();
            
            // Clear tempFODetails
            tempFODetails = {
                category: null,
                symbol: null,
                futuresExpiry: null,
                optionsExpiry: null,
                optionsType: null,
                optionsStrike: null
            };
            
            renderTransactions();
            alert('‚úì Transaction added successfully!');
        }

        function renderTransactions() {
            const list = document.getElementById('transactions-list');
            
            if (transactions.length === 0) {
                list.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px; color: #999;">No transactions yet</td></tr>';
                return;
            }

            const sorted = [...transactions].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            list.innerHTML = sorted.map(txn => {
                // Use displayDate if available, otherwise format date as dd-mmm-yy
                let formattedDate;
                if (txn.displayDate) {
                    formattedDate = txn.displayDate;
                } else {
                    const date = new Date(txn.date);
                    formattedDate = date.toLocaleDateString('en-GB', { 
                        day: '2-digit', 
                        month: 'short', 
                        year: '2-digit' 
                    });
                }
                
                // Format numbers with commas
                const formattedQty = Math.abs(txn.quantity).toLocaleString('en-IN');
                const formattedPrice = txn.price.toLocaleString('en-IN', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
                const formattedTotal = txn.total.toLocaleString('en-IN', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
                
                // Build symbol display with category info
                let symbolDisplay = `<strong>${txn.symbol}</strong>`;
                
                // Add category badge
                const categoryLabels = {
                    'eq-delivery': 'EQ-D',
                    'eq-intraday': 'EQ-I',
                    'futures': 'FUT',
                    'options': 'OPT'
                };
                const categoryLabel = categoryLabels[txn.category] || txn.category || 'EQ-D';
                symbolDisplay += ` <span style="font-size: 10px; background: #e5e7eb; padding: 2px 6px; border-radius: 3px; font-weight: 600;">${categoryLabel}</span>`;
                
                // Add F&O details
                if (txn.category === 'futures' && txn.futuresExpiry) {
                    symbolDisplay += `<br><span style="font-size: 11px; color: #666;">Exp: ${txn.futuresExpiry}</span>`;
                } else if (txn.category === 'options' && txn.optionsExpiry) {
                    symbolDisplay += `<br><span style="font-size: 11px; color: #666;">${txn.optionsExpiry} ${txn.optionsType || ''} ${txn.optionsStrike ? '‚Çπ' + txn.optionsStrike : ''}</span>`;
                }
                
                return `
                    <tr>
                        <td>${formattedDate}</td>
                        <td>${txn.investorName}</td>
                        <td><span class="badge ${txn.type === 'buy' ? 'badge-buy' : 'badge-sell'}">${txn.type.toUpperCase()}</span></td>
                        <td>${symbolDisplay}</td>
                        <td class="text-right">${formattedQty}</td>
                        <td class="text-right">${formattedPrice}</td>
                        <td class="text-right">${formattedTotal}</td>
                        <td>${txn.tags && txn.tags.length > 0 ? txn.tags.map(tag => `<span class="tag">${tag}</span>`).join('') : ''}</td>
                    </tr>
                `;
            }).join('');
        }

        // Portfolio sorting
        let portfolioSortColumn = 'symbol';
        let portfolioSortDirection = 'asc';
        let expandedSymbol = null;

        function sortPortfolio(column) {
            if (portfolioSortColumn === column) {
                portfolioSortDirection = portfolioSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                portfolioSortColumn = column;
                portfolioSortDirection = 'asc';
            }
            renderPortfolio();
        }

        // Portfolio
        // Portfolio filtering with searchable tags
        let selectedInvestorIds = [];
        let selectedTagNames = [];
        let selectedTxnTags = []; // For transaction form
        let tagFilterLogic = 'OR'; // 'OR' or 'AND'

        function updateTagLogic() {
            const selected = document.querySelector('input[name="tag-logic"]:checked');
            tagFilterLogic = selected ? selected.value : 'OR';
            renderPortfolio();
        }

        function filterInvestorSearch() {
            const searchText = document.getElementById('investor-search-input').value.toLowerCase();
            const dropdown = document.getElementById('investor-dropdown');
            
            const matches = investors.filter(inv => 
                inv.name.toLowerCase().includes(searchText)
            );
            
            if (matches.length === 0) {
                dropdown.innerHTML = '<div class="filter-dropdown-empty">No investors found</div>';
            } else {
                dropdown.innerHTML = matches.map(inv => {
                    const isSelected = selectedInvestorIds.includes(inv.id);
                    return `<div class="filter-dropdown-item ${isSelected ? 'selected' : ''}" 
                                 onmousedown="event.preventDefault(); toggleInvestorFilter('${inv.id}', '${inv.name.replace(/'/g, "\\'")}')">
                        ${inv.name} ${isSelected ? '‚úì' : ''}
                    </div>`;
                }).join('');
            }
            
            dropdown.classList.add('show');
        }

        function showInvestorDropdown() {
            filterInvestorSearch();
            setTimeout(() => {
                document.addEventListener('click', handleClickOutsideInvestor);
            }, 0);
        }

        function handleClickOutsideInvestor(e) {
            const input = document.getElementById('investor-search-input');
            const dropdown = document.getElementById('investor-dropdown');
            
            // Check if click is outside both input and dropdown
            if (!input.contains(e.target) && !dropdown.contains(e.target)) {
                dropdown.classList.remove('show');
                document.removeEventListener('click', handleClickOutsideInvestor);
            }
        }

        function toggleInvestorFilter(investorId, investorName) {
            if (selectedInvestorIds.includes(investorId)) {
                selectedInvestorIds = selectedInvestorIds.filter(id => id !== investorId);
            } else {
                selectedInvestorIds.push(investorId);
            }
            renderSelectedInvestors();
            renderPortfolio();
            filterInvestorSearch();
        }

        function clearInvestorFilters() {
            selectedInvestorIds = [];
            renderSelectedInvestors();
            renderPortfolio();
        }

        function removeInvestorFilter(investorId) {
            selectedInvestorIds = selectedInvestorIds.filter(id => id !== investorId);
            renderSelectedInvestors();
            renderPortfolio();
        }

        function renderSelectedInvestors() {
            const container = document.getElementById('selected-investors');
            const selectedInvestors = investors.filter(inv => selectedInvestorIds.includes(inv.id));
            
            container.innerHTML = selectedInvestors.map(inv => 
                `<div class="filter-tag-item">
                    ${inv.name}
                    <span class="filter-tag-remove" onclick="removeInvestorFilter('${inv.id}')">&times;</span>
                </div>`
            ).join('');
        }

        function filterTagSearch() {
            const searchText = document.getElementById('tag-search-input').value.toLowerCase();
            const dropdown = document.getElementById('tag-dropdown');
            
            const allTags = new Set();
            transactions.forEach(txn => txn.tags.forEach(tag => allTags.add(tag)));
            
            const matches = Array.from(allTags).filter(tag => 
                tag.toLowerCase().includes(searchText)
            );
            
            if (matches.length === 0) {
                dropdown.innerHTML = '<div class="filter-dropdown-empty">No tags found</div>';
            } else {
                dropdown.innerHTML = matches.sort().map(tag => {
                    const isSelected = selectedTagNames.includes(tag);
                    return `<div class="filter-dropdown-item ${isSelected ? 'selected' : ''}" 
                                 onmousedown="event.preventDefault(); toggleTagFilter('${tag.replace(/'/g, "\\'")}')">
                        ${tag} ${isSelected ? '‚úì' : ''}
                    </div>`;
                }).join('');
            }
            
            dropdown.classList.add('show');
        }

        function showTagDropdown() {
            filterTagSearch();
            setTimeout(() => {
                document.addEventListener('click', handleClickOutsideTag);
            }, 0);
        }

        function handleClickOutsideTag(e) {
            const input = document.getElementById('tag-search-input');
            const dropdown = document.getElementById('tag-dropdown');
            
            // Check if click is outside both input and dropdown
            if (!input.contains(e.target) && !dropdown.contains(e.target)) {
                dropdown.classList.remove('show');
                document.removeEventListener('click', handleClickOutsideTag);
            }
        }

        function toggleTagFilter(tagName) {
            if (selectedTagNames.includes(tagName)) {
                selectedTagNames = selectedTagNames.filter(t => t !== tagName);
            } else {
                selectedTagNames.push(tagName);
            }
            renderSelectedTags();
            renderPortfolio();
            filterTagSearch();
        }

        function clearInvestorFilters() {
            selectedInvestorIds = [];
            renderSelectedInvestors();
            renderPortfolio();
        }

        function clearTagFilters() {
            selectedTagNames = [];
            renderSelectedTags();
            renderPortfolio();
        }

        function removeTagFilter(tagName) {
            selectedTagNames = selectedTagNames.filter(t => t !== tagName);
            renderSelectedTags();
            renderPortfolio();
        }

        function renderSelectedTags() {
            const container = document.getElementById('selected-tags');
            
            container.innerHTML = selectedTagNames.map(tag => 
                `<div class="filter-tag-item">
                    ${tag}
                    <span class="filter-tag-remove" onclick="removeTagFilter('${tag.replace(/'/g, "\\'")}')">√ó</span>
                </div>`
            ).join('');
        }

        function calculateHoldings() {
            const holdings = {};
            
            // Filter transactions first
            let filteredTransactions = transactions;
            
            if (selectedInvestorIds.length > 0) {
                filteredTransactions = filteredTransactions.filter(txn => 
                    selectedInvestorIds.includes(txn.investorId)
                );
            }
            
            if (selectedTagNames.length > 0) {
                if (tagFilterLogic === 'AND') {
                    // AND logic: transaction must have ALL selected tags
                    filteredTransactions = filteredTransactions.filter(txn => 
                        selectedTagNames.every(tag => txn.tags.includes(tag))
                    );
                } else {
                    // OR logic: transaction must have ANY selected tag
                    filteredTransactions = filteredTransactions.filter(txn => 
                        txn.tags.some(tag => selectedTagNames.includes(tag))
                    );
                }
            }
            
            filteredTransactions.forEach(txn => {
                const key = `${txn.symbol}-${txn.exchange}`;
                
                if (!holdings[key]) {
                    holdings[key] = {
                        symbol: txn.symbol,
                        exchange: txn.exchange,
                        quantity: 0,
                        totalCost: 0,
                        tags: new Set(),
                        latestPrice: 0,
                        latestDate: null
                    };
                }
                
                holdings[key].quantity += txn.quantity;
                // Use txn.total which includes costs (added for buy, reduced for sell)
                // For buy: total = (qty * price) + costs
                // For sell: total = (qty * price) - costs (negative qty, so adds negative total)
                holdings[key].totalCost += txn.total;
                txn.tags.forEach(tag => holdings[key].tags.add(tag));
                
                // Track latest transaction price
                const txnDate = new Date(txn.date);
                if (!holdings[key].latestDate || txnDate > holdings[key].latestDate) {
                    holdings[key].latestDate = txnDate;
                    holdings[key].latestPrice = txn.price;
                }
            });
            
            return Object.values(holdings)
                .filter(h => h.quantity > 0)
                .map(h => ({
                    ...h,
                    avgCost: h.totalCost / h.quantity,
                    tags: Array.from(h.tags)
                }));
        }

        function renderPortfolio() {
            const list = document.getElementById('portfolio-list');
            
            let holdings = calculateHoldings();
            
            if (holdings.length === 0) {
                list.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: #999;">No holdings to display</td></tr>';
                document.getElementById('portfolio-summary').innerHTML = '';
                return;
            }

            let totalInvested = 0;
            let totalValue = 0;
            
            // First pass to calculate totals
            holdings.forEach(h => {
                const currentPrice = h.latestPrice; // Use latest transaction price
                const currentValue = h.quantity * currentPrice;
                const totalCost = h.quantity * h.avgCost;
                totalInvested += totalCost;
                totalValue += currentValue;
            });
            
            const totalPL = totalValue - totalInvested;
            const totalPLPercent = totalInvested > 0 ? (totalPL / totalInvested) * 100 : 0;
            
            // Sort holdings
            holdings.sort((a, b) => {
                let valA, valB;
                const priceA = a.latestPrice;
                const priceB = b.latestPrice;
                
                switch(portfolioSortColumn) {
                    case 'symbol':
                        valA = a.symbol;
                        valB = b.symbol;
                        break;
                    case 'quantity':
                        valA = a.quantity;
                        valB = b.quantity;
                        break;
                    case 'invested':
                        valA = a.quantity * a.avgCost;
                        valB = b.quantity * b.avgCost;
                        break;
                    case 'price':
                        valA = priceA;
                        valB = priceB;
                        break;
                    case 'pl':
                        valA = (a.quantity * priceA) - (a.quantity * a.avgCost);
                        valB = (b.quantity * priceB) - (b.quantity * b.avgCost);
                        break;
                    case 'value':
                        valA = a.quantity * priceA;
                        valB = b.quantity * priceB;
                        break;
                    default:
                        valA = a.symbol;
                        valB = b.symbol;
                }
                
                if (typeof valA === 'string') {
                    return portfolioSortDirection === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
                } else {
                    return portfolioSortDirection === 'asc' ? valA - valB : valB - valA;
                }
            });
            
            // Update sort indicators
            document.querySelectorAll('.sort-indicator').forEach(el => el.textContent = '');
            const indicator = portfolioSortDirection === 'asc' ? '‚ñ≤' : '‚ñº';
            const sortElement = document.getElementById(`sort-${portfolioSortColumn}`);
            if (sortElement) sortElement.textContent = indicator;
            
            // Format totals
            const formattedTotalInvested = totalInvested.toLocaleString('en-IN', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
            const formattedTotalPL = Math.abs(totalPL).toLocaleString('en-IN', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
            const formattedTotalValue = totalValue.toLocaleString('en-IN', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
            
            // Build total row
            const totalRow = `
                <tr class="total-row">
                    <td colspan="2" style="text-align: left;">TOTAL</td>
                    <td class="text-right">
                        <div>${formattedTotalInvested}</div>
                        <div style="font-size: 11px; color: #666; margin-top: 2px;">100.00%</div>
                    </td>
                    <td class="text-right"></td>
                    <td class="text-right" style="color: ${totalPL >= 0 ? '#10b981' : '#ef4444'}; font-weight: 600;">
                        <div>${totalPL >= 0 ? formattedTotalPL : '(' + formattedTotalPL + ')'}</div>
                        <div style="font-size: 11px; margin-top: 2px;">${totalPLPercent >= 0 ? totalPLPercent.toFixed(2) : '(' + Math.abs(totalPLPercent).toFixed(2) + ')'}%</div>
                    </td>
                    <td class="text-right">
                        <div>${formattedTotalValue}</div>
                        <div style="font-size: 11px; color: #666; margin-top: 2px;">100.00%</div>
                    </td>
                    <td></td>
                </tr>
            `;
            
            const rows = holdings.map((h, index) => {
                const currentPrice = h.latestPrice; // Use latest transaction price
                const currentValue = h.quantity * currentPrice;
                const totalCost = h.quantity * h.avgCost;
                const pl = currentValue - totalCost;
                const plPercent = (pl / totalCost) * 100;
                const percentOfTotalValue = (currentValue / totalValue) * 100;
                const percentOfTotalInvested = (totalCost / totalInvested) * 100;
                
                // Format numbers with commas
                const formattedQty = h.quantity.toLocaleString('en-IN');
                const formattedAvgCost = h.avgCost.toLocaleString('en-IN', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
                const formattedInvestedValue = totalCost.toLocaleString('en-IN', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
                const formattedCurrentPrice = currentPrice.toLocaleString('en-IN', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
                const formattedCurrentValue = currentValue.toLocaleString('en-IN', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
                const formattedPL = Math.abs(pl).toLocaleString('en-IN', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
                
                const isExpanded = expandedSymbol === `${h.symbol}-${h.exchange}`;
                const symbolKey = `${h.symbol}-${h.exchange}`;
                
                let mainRow = `
                    <tr class="${isExpanded ? 'expanded-row' : ''}">
                        <td><strong class="symbol-clickable" onclick="toggleSymbolDetail('${h.symbol}', '${h.exchange}')">${h.symbol}</strong> (${h.exchange})</td>
                        <td class="text-right">
                            <div>${formattedQty}</div>
                            <div style="font-size: 11px; color: #666; margin-top: 2px;">${formattedAvgCost}</div>
                        </td>
                        <td class="text-right">
                            <div>${formattedInvestedValue}</div>
                            <div style="font-size: 11px; color: #666; margin-top: 2px;">${percentOfTotalInvested.toFixed(2)}%</div>
                        </td>
                        <td class="text-right">${formattedCurrentPrice}</td>
                        <td class="text-right ${pl >= 0 ? 'text-green' : 'text-red'}" style="font-weight: 600;">
                            <div>${pl >= 0 ? formattedPL : '(' + formattedPL + ')'}</div>
                            <div style="font-size: 11px; margin-top: 2px;">${plPercent >= 0 ? plPercent.toFixed(2) : '(' + Math.abs(plPercent).toFixed(2) + ')'}%</div>
                        </td>
                        <td class="text-right">
                            <div>${formattedCurrentValue}</div>
                            <div style="font-size: 11px; color: #666; margin-top: 2px;">${percentOfTotalValue.toFixed(2)}%</div>
                        </td>
                        <td>${h.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}</td>
                    </tr>
                `;
                
                // Add detail row if expanded
                let detailRow = '';
                if (isExpanded) {
                    // Group transactions by investor for this symbol
                    const symbolTxns = transactions.filter(txn => txn.symbol === h.symbol && txn.exchange === h.exchange);
                    const investorGroups = {};
                    
                    symbolTxns.forEach(txn => {
                        if (!investorGroups[txn.investorId]) {
                            investorGroups[txn.investorId] = {
                                name: txn.investorName,
                                quantity: 0,
                                totalCost: 0,
                                tags: new Set()
                            };
                        }
                        investorGroups[txn.investorId].quantity += txn.quantity;
                        investorGroups[txn.investorId].totalCost += (txn.quantity * txn.price);
                        txn.tags.forEach(tag => investorGroups[txn.investorId].tags.add(tag));
                    });
                    
                    const investorRows = Object.values(investorGroups)
                        .filter(inv => inv.quantity > 0)
                        .map(inv => {
                            const invAvgCost = inv.totalCost / inv.quantity;
                            const invCurrentValue = inv.quantity * currentPrice; // Use same currentPrice (latest)
                            const invTotalCost = inv.quantity * invAvgCost;
                            const invPL = invCurrentValue - invTotalCost;
                            const invPLPercent = (invPL / invTotalCost) * 100;
                            const invPercentOfInvested = totalInvested > 0 ? (invTotalCost / totalInvested) * 100 : 0;
                            const invPercentOfValue = totalValue > 0 ? (invCurrentValue / totalValue) * 100 : 0;
                            
                            return `
                                <tr>
                                    <td>${inv.name}</td>
                                    <td class="text-right">
                                        <div>${inv.quantity.toLocaleString('en-IN')}</div>
                                        <div style="font-size: 11px; color: #666; margin-top: 2px;">${invAvgCost.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                                    </td>
                                    <td class="text-right">
                                        <div>${invTotalCost.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                                        <div style="font-size: 11px; color: #666; margin-top: 2px;">${invPercentOfInvested.toFixed(2)}%</div>
                                    </td>
                                    <td class="text-right">${currentPrice.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                                    <td class="text-right ${invPL >= 0 ? 'text-green' : 'text-red'}" style="font-weight: 600;">
                                        <div>${invPL >= 0 ? Math.abs(invPL).toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '(' + Math.abs(invPL).toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ')'}</div>
                                        <div style="font-size: 11px; margin-top: 2px;">${invPLPercent >= 0 ? invPLPercent.toFixed(2) : '(' + Math.abs(invPLPercent).toFixed(2) + ')'}%</div>
                                    </td>
                                    <td class="text-right">
                                        <div>${invCurrentValue.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                                        <div style="font-size: 11px; color: #666; margin-top: 2px;">${invPercentOfValue.toFixed(2)}%</div>
                                    </td>
                                    <td>${Array.from(inv.tags).map(tag => `<span class="tag">${tag}</span>`).join('')}</td>
                                </tr>
                            `;
                        }).join('');
                    
                    detailRow = `
                        <tr class="detail-row">
                            <td colspan="7">
                                <table class="inner-table">
                                    <tbody>
                                        ${investorRows}
                                    </tbody>
                                </table>
                            </td>
                        </tr>
                    `;
                }
                
                return mainRow + detailRow;
            }).join('');
            
            list.innerHTML = totalRow + rows;
            
            document.getElementById('portfolio-summary').innerHTML = `
                <div class="summary-card blue">
                    <p>Total Invested</p>
                    <p style="color: #2563eb;">‚Çπ${totalInvested.toLocaleString('en-IN', {maximumFractionDigits: 2})}</p>
                </div>
                <div class="summary-card green">
                    <p>Current Value</p>
                    <p style="color: #10b981;">‚Çπ${totalValue.toLocaleString('en-IN', {maximumFractionDigits: 2})}</p>
                </div>
                <div class="summary-card ${totalPL >= 0 ? 'green' : 'red'}">
                    <p>Total P&L</p>
                    <p style="color: ${totalPL >= 0 ? '#10b981' : '#ef4444'};">
                        ${totalPL >= 0 ? '+' : ''}‚Çπ${totalPL.toLocaleString('en-IN', {maximumFractionDigits: 2})}
                        <span style="font-size: 16px;"> (${totalPLPercent >= 0 ? '+' : ''}${totalPLPercent.toFixed(2)}%)</span>
                    </p>
                </div>
            `;
        }

        // Toggle symbol detail expansion
        function toggleSymbolDetail(symbol, exchange) {
            const symbolKey = `${symbol}-${exchange}`;
            if (expandedSymbol === symbolKey) {
                expandedSymbol = null;
            } else {
                expandedSymbol = symbolKey;
            }
            renderPortfolio();
        }

        // CSV Import (no external libraries needed)
        function importCSV(event) {
            const file = event.target.files[0];
            if (!file) {
                console.log('No file selected');
                return;
            }
            
            console.log('File selected:', file.name);
            
            const reader = new FileReader();
            
            reader.onerror = function(error) {
                console.error('FileReader error:', error);
                alert('Error reading file: ' + error);
                event.target.value = '';
            };
            
            reader.onload = function(e) {
                console.log('File loaded, processing...');
                try {
                    const text = e.target.result;
                    console.log('File content length:', text.length);
                    
                    const lines = text.split('\n').map(line => line.trim()).filter(line => line);
                    console.log('Number of lines:', lines.length);
                    
                    if (lines.length < 2) {
                        alert('CSV file is empty or has no data rows.');
                        event.target.value = '';
                        return;
                    }
                    
                    // Parse header
                    const headers = parseCSVLine(lines[0]);
                    console.log('Headers:', headers);
                    
                    // Validate headers
                    const requiredHeaders = ['Date', 'Investor Name', 'Investor ID', 'Type', 'Symbol', 'Exchange', 'Quantity', 'Price'];
                    const missingHeaders = requiredHeaders.filter(h => !headers.includes(h));
                    if (missingHeaders.length > 0) {
                        alert('Missing required columns: ' + missingHeaders.join(', '));
                        event.target.value = '';
                        return;
                    }
                    
                    let importedCount = 0;
                    let skippedCount = 0;
                    const errors = [];
                    
                    console.log('Processing', lines.length - 1, 'data rows...');
                    
                    // Process data rows
                    for (let i = 1; i < lines.length; i++) {
                        try {
                            const values = parseCSVLine(lines[i]);
                            console.log('Row', i, 'values:', values);
                            
                            if (values.length !== headers.length) {
                                errors.push(`Row ${i + 1}: Column count mismatch (expected ${headers.length}, got ${values.length})`);
                                skippedCount++;
                                continue;
                            }
                            
                            const row = {};
                            headers.forEach((header, index) => {
                                row[header] = values[index];
                            });
                            
                            // Skip rows without date (blank rows)
                            if (!row['Date'] || row['Date'].trim() === '') {
                                continue;
                            }
                            
                            // Validate other required fields
                            if (!row['Investor Name'] || !row['Type'] || !row['Symbol'] || 
                                !row['Exchange'] || !row['Quantity'] || !row['Price']) {
                                errors.push(`Row ${i + 1}: Missing required fields`);
                                skippedCount++;
                                continue;
                            }
                            
                            // Parse and normalize date
                            let date = row['Date'];
                            // Handle dd-mmm-yy format (e.g., 05-Jan-26)
                            if (date.match(/^\d{1,2}-[A-Za-z]{3}-\d{2}$/)) {
                                const parts = date.split('-');
                                const day = parts[0].padStart(2, '0');
                                const monthMap = {
                                    'jan': '01', 'feb': '02', 'mar': '03', 'apr': '04',
                                    'may': '05', 'jun': '06', 'jul': '07', 'aug': '08',
                                    'sep': '09', 'oct': '10', 'nov': '11', 'dec': '12'
                                };
                                const month = monthMap[parts[1].toLowerCase()];
                                const year = '20' + parts[2];
                                date = `${year}-${month}-${day}`;
                            }
                            
                            const investorName = String(row['Investor Name']).trim();
                            const type = String(row['Type']).toLowerCase().trim();
                            const symbol = String(row['Symbol']).toUpperCase().trim();
                            const exchange = String(row['Exchange']).toUpperCase().trim();
                            
                            // Parse numbers - remove commas
                            const quantityStr = String(row['Quantity']).replace(/,/g, '');
                            const priceStr = String(row['Price']).replace(/,/g, '');
                            const quantity = parseFloat(quantityStr);
                            const price = parseFloat(priceStr);
                            
                            if (isNaN(quantity) || isNaN(price)) {
                                errors.push(`Row ${i + 1}: Invalid quantity or price`);
                                skippedCount++;
                                continue;
                            }
                            
                            const tagsStr = row['Tags'] ? String(row['Tags']).trim() : '';
                            
                            // Validate type
                            if (type !== 'buy' && type !== 'sell') {
                                errors.push(`Row ${i + 1}: Type must be 'buy' or 'sell'`);
                                skippedCount++;
                                continue;
                            }
                            
                            // Validate exchange
                            if (exchange !== 'NSE' && exchange !== 'BSE') {
                                errors.push(`Row ${i + 1}: Exchange must be 'NSE' or 'BSE'`);
                                skippedCount++;
                                continue;
                            }
                            
                            // Check if investor exists by name
                            let investor = investors.find(inv => inv.name.toLowerCase() === investorName.toLowerCase());
                            
                            if (!investor) {
                                // Create new investor
                                // Use provided Investor ID, or generate from name if empty
                                let investorPAN = row['Investor ID'] ? String(row['Investor ID']).trim().toUpperCase() : '';
                                if (!investorPAN) {
                                    investorPAN = investorName.trim().replace(/\s+/g, '_').toUpperCase();
                                }
                                
                                investor = {
                                    id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                                    name: investorName,
                                    pan: investorPAN,
                                    createdAt: new Date().toISOString()
                                };
                                investors.push(investor);
                                console.log('Created new investor:', investor.name, 'with ID:', investor.pan);
                            }
                            
                            // Parse tags
                            const tags = tagsStr ? tagsStr.split(',').map(t => t.trim()).filter(t => t) : [];
                            
                            // Create transaction
                            const txnQuantity = type === 'sell' ? -quantity : quantity;
                            transactions.push({
                                id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                                investorId: investor.id,
                                investorName: investor.name,
                                type: type,
                                symbol: symbol,
                                exchange: exchange,
                                quantity: txnQuantity,
                                price: price,
                                total: quantity * price,
                                date: date,
                                tags: tags
                            });
                            
                            importedCount++;
                            
                        } catch (err) {
                            console.error('Error processing row', i, ':', err);
                            errors.push(`Row ${i + 1}: ${err.message}`);
                            skippedCount++;
                        }
                    }
                    
                    console.log('Import complete. Imported:', importedCount, 'Skipped:', skippedCount);
                    
                    // Save to localStorage
                    localStorage.setItem('investors', JSON.stringify(investors));
                    localStorage.setItem('transactions', JSON.stringify(transactions));
                    
                    // Update UI
                    renderInvestors();
                    renderTransactions();
                    updateDropdowns();
                    
                    // Clear file input
                    event.target.value = '';
                    
                    // Show results
                    let message = `‚úì Import Complete!\n\nImported: ${importedCount} transactions\n`;
                    if (skippedCount > 0) {
                        message += `Skipped: ${skippedCount} rows\n`;
                    }
                    if (errors.length > 0) {
                        message += `\nErrors:\n${errors.slice(0, 5).join('\n')}`;
                        if (errors.length > 5) {
                            message += `\n... and ${errors.length - 5} more errors`;
                        }
                    }
                    alert(message);
                    
                } catch (error) {
                    console.error('CSV import error:', error);
                    alert('Error importing CSV file: ' + error.message);
                    event.target.value = '';
                }
            };
            
            reader.readAsText(file);
        }
        
        // Helper function to parse CSV line (handles quoted fields)
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    if (inQuotes && line[i + 1] === '"') {
                        current += '"';
                        i++;
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current.trim());
            return result;
        }

        function updateDropdowns() {
            const txnInvestorBrokerSelect = document.getElementById('txn-investor-broker');
            
            // Build combined investor > broker options
            let combinedOptions = '';
            investors.forEach(inv => {
                if (!inv.brokers) inv.brokers = [];
                
                if (inv.brokers.length === 0) {
                    // Show investor with no brokers (disabled)
                    combinedOptions += `<option value="" disabled>${inv.name} (No brokers)</option>`;
                } else {
                    // Show each broker for this investor
                    inv.brokers.forEach(brokerRel => {
                        const broker = brokers.find(b => b.id === brokerRel.brokerId);
                        if (broker) {
                            combinedOptions += `<option value="${inv.id}|${broker.id}">${inv.name} > ${broker.name}</option>`;
                        }
                    });
                }
            });
            
            if (txnInvestorBrokerSelect) {
                txnInvestorBrokerSelect.innerHTML = '<option value="">Select investor & broker...</option>' + combinedOptions;
            }
        }

        // Export/Import Functions
        function exportData() {
            console.log('Export function called');
            console.log('Investors:', investors.length);
            console.log('Brokers:', brokers.length);
            console.log('Transactions:', transactions.length);
            
            const data = {
                investors,
                brokers,
                otherCosts,
                transactions,
                prices,
                exportDate: new Date().toISOString()
            };

            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `wealth-data-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            console.log('Export completed');
            alert('‚úì Data exported successfully!');
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (data.investors && data.transactions && data.prices) {
                        // Confirm before overwriting
                        if (investors.length > 0 || brokers.length > 0 || transactions.length > 0) {
                            if (!confirm('This will replace your current data. Continue?')) {
                                event.target.value = '';
                                return;
                            }
                        }
                        
                        investors = data.investors;
                        brokers = data.brokers || [];
                        otherCosts = data.otherCosts || {
                            eqDelivery: { pct: 0 },
                            eqIntraday: { pct: 0 },
                            futures: { pct: 0 },
                            options: { pct: 0 }
                        };
                        transactions = data.transactions;
                        prices = data.prices;
                        
                        localStorage.setItem('investors', JSON.stringify(investors));
                        localStorage.setItem('brokers', JSON.stringify(brokers));
                        localStorage.setItem('otherCosts', JSON.stringify(otherCosts));
                        localStorage.setItem('transactions', JSON.stringify(transactions));
                        localStorage.setItem('prices', JSON.stringify(prices));
                        
                        renderInvestors();
                        renderBrokers();
                        loadOtherCosts();
                        renderTransactions();
                        updateDropdowns();
                        
                        event.target.value = '';
                        
                        alert(`‚úì Data imported successfully!\n\nInvestors: ${investors.length}\nTransactions: ${transactions.length}\nPrices: ${Object.keys(prices).length} stocks`);
                    } else {
                        alert('Invalid data file. Please select a valid export file.');
                    }
                } catch (error) {
                    console.error('Import error:', error);
                    alert('Error importing data. Please check the file and try again.');
                }
            };
            
            reader.readAsText(file);
        }
        
        // Add delete all data button listener
        console.log('Script loaded');
        const deleteBtn = document.getElementById('delete-all-btn');
        console.log('Delete button:', deleteBtn);
        
        if (deleteBtn) {
            deleteBtn.addEventListener('click', function() {
                console.log('Delete button clicked');
                document.getElementById('delete-modal').style.display = 'flex';
            });
        } else {
            console.error('Delete button not found!');
        }
        
        // Delete modal functions
        window.closeDeleteModal = function() {
            document.getElementById('delete-modal').style.display = 'none';
        };
        
        window.confirmDelete = function() {
            console.log('Deleting all data...');
            
            // Clear all data
            investors = [];
            brokers = [];
            otherCosts = {
                eqDelivery: { pct: 0 },
                eqIntraday: { pct: 0 },
                futures: { pct: 0 },
                options: { pct: 0 }
            };
            transactions = [];
            prices = {};
            selectedInvestorIds = [];
            selectedTagNames = [];
            
            // Clear localStorage
            localStorage.removeItem('investors');
            localStorage.removeItem('brokers');
            localStorage.removeItem('otherCosts');
            localStorage.removeItem('transactions');
            localStorage.removeItem('prices');
            
            console.log('Data cleared');
            
            // Refresh UI
            renderInvestors();
            renderBrokers();
            loadOtherCosts();
            renderTransactions();
            renderPortfolio();
            updateDropdowns();
            
            console.log('UI refreshed');
            
            // Close modal
            closeDeleteModal();
            
            alert('‚úì All data has been deleted!');
        };
    </script>
</body>
</html>